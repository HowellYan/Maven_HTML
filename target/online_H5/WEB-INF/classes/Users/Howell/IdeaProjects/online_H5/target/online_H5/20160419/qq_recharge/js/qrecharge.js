define(["jquery","bestpay.ui","bestpay.lang","bestpay.http"],function(a,c,f,b){var d=null;function e(){d=this;this.noPwd=false;this.qqNum="";this.userInfo=JSON.parse(Bestpay.User.getSuccessLoginInfo());this.itemValue="1015";this.quanlitynum=50;this.qbInputNum="";this.buyMoney="";this._pName="10";this.userId="";this.ipPassword=null;this.orderPageJson={};this.successJson={};this.userPhone="";this.payType="0";this.checkBillCheck=false;this.rechargeData={};this.productId="0030001";this.selectBuyNumList=null;this.select_buy_num_fun=null;this.defferred=null;this.businessName="QQ充值"}e.prototype.initApp=function(){var g=this;config.TRADE_LIST_QUERY_TYPE=config.BUS_TYPE.BUS_TYPE_QQ;goTo(config.page.main,function(){g.qqNum=new c.InputText("QQnumber","number");document.getElementById("id_resource").onclick=function(){goTo(config.page.select_bank,function(){});var h=new c.dropDownBox("id_resource_list",this,{"Q币":"1015","QQ会员":"1013","QQ堂(紫钻)":"1012","QQ秀(红钻)":"1011","QQ游戏(蓝钻)":"1010","QQ空间(黄钻)":"1014"},function(j,i){h.hideDropDownBox();d.itemObjHtml=a(i).html();d.itemValue=j;a("#resource_show").html(d.itemObjHtml);g.loadSelectItem(j);g.qbInputNum.clearValue();back();setTimeout(function(){a("#select_buy_num").trigger("click")},200)},function(){h.hideDropDownBox();back()})};g.qbInputNum=new c.InputText("quantity","number",function(h){if(a("#id_buyNum_list").css("display")!="none"){g.flatFeeBox.hideDropDownBox();back()}},function(){document.getElementById("select_buy_num").onclick=g.select_buy_num_fun});g.userPhone=new c.InputText("userPhone","mobile");g.userPhone.clearValue();g.loadSelectItem("1015");g.btnInit()})};e.prototype.btnInit=function(){var g=this;g.select_buy_num_fun=function(){a("#id_buyNum_list").html("");goTo(config.page.select_buy_num,function(){});g.flatFeeBox=new c.dropDownBox("id_buyNum_list",this,g.selectBuyNumList,function(h,i){g.flatFeeBox.hideDropDownBox();if(h=="0"){a("#select_buy_num_list").hide();a("#quantity").show();document.getElementById("select_buy_num").onclick=null;back();return}a("#select_buy_num_list").show();a("#quantity").hide();d.itemObjHtml_=a(i).html();d.quanlitynum=h;a("#select_buy_num_val").html(d.itemObjHtml_);back()},function(){g.flatFeeBox.hideDropDownBox();back()})};document.getElementById("select_buy_num").onclick=g.select_buy_num_fun;document.getElementById("btn_next").onclick=function(){g.checkBillCheck=false;g.initClick()}};e.prototype.loadSelectItem=function(i){var g=this;if(i=="1015"){g.selectBuyNumList=config.selectItem.qb;a("#buyQbNum").show()}else{g.selectBuyNumList=config.selectItem.other;a("#buyQbNum").hide()}document.getElementById("select_buy_num").onclick=g.select_buy_num_fun;for(var h in g.selectBuyNumList){if(g.selectBuyNumList[h]=="50"||h=="1个月"){a("#select_buy_num_val").text(h);g.quanlitynum=g.selectBuyNumList[h];a("#select_buy_num_list").show();a("#quantity").hide();return}}};e.prototype.initClick=function(){var g=this;var h=g.qqNum.getToEmptyValue();var i=g.qbInputNum.getToEmptyValue();if(h.length<5){Bestpay.Toast.makeText("请输入正确的QQ号码",Bestpay.Toast.LENGTH_SHORT);return}if(i!=""&&parseInt(i)<5){Bestpay.Toast.makeText("充值Q币单笔不能小于5个",Bestpay.Toast.LENGTH_SHORT);return}if(i!=""&&parseInt(i)>500){Bestpay.Toast.makeText("充值Q币单笔不能超过500个",Bestpay.Toast.LENGTH_SHORT);return}this.mobile_val=g.userPhone.getToEmptyValue().replace(" ","");if(this.mobile_val!=null&&this.mobile_val!=""){if(this.mobile_val.length>11||this.mobile_val.length<11){Bestpay.Toast.makeText("请输入11位的顾客手机号码",Bestpay.Toast.LENGTH_SHORT);return}else{if(this.mobile_val.length!=11||!this.userPhone.getInputCheck()){Bestpay.Toast.makeText("您输入的手机号号码段不正确",Bestpay.Toast.LENGTH_SHORT);return}}}g.buyMoney=g.qbInputNum.getToEmptyValue()!=null&&g.qbInputNum.getToEmptyValue()!=""?g.qbInputNum.getToEmptyValue():g.quanlitynum;g.itJudgeLocalStorage=new c.JudgeLocalStorage();g.itJudgeLocalStorage.checkOrder(h,g.buyMoney*1,b.getCurrentTime(),function(){g.queryStart();g.SDiscQuery();g.defferred.done(g.goPayAnimation)},g.businessName)};e.prototype.SDiscQuery=function(){var g=this;b.callCPSService({service:config.CPS.SDISCQUERY,params:g.SDiscQueryParams(),showLoading:false,success:g.SDiscQuerySuccessCallback})};e.prototype.SDiscQueryParams=function(){var g=this;var h={rechAmount:f.yuan2fen(g.buyMoney),pecProduct:config.QQproductCode[g.itemValue]};h=b.setCPSCommonParams(h);console.log("折价查询SDISCQUERY 入参==");return h};e.prototype.SDiscQuerySuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){Bestpay.Dialog.showAlertDialog("提醒",g.content,"确定",g.code);return}console.log("折价查询SDISCQUERY 出参=="+JSON.stringify(g));d.orderPageJson={};d.orderPageJson.rewardType="zhejia";d.orderPageJson.reward=f.fen2yuan(g.discAmount);d.orderPageJson.contact=d.qqNum.getToEmptyValue();d.orderPageJson.cardAmount=(d.buyMoney*1).toFixed(2);d.orderPageJson.supplyCode=g.supplyCode;d.orderPageJson.buyTypeName=d.itemValue=="1015"?"充值数据":"充值时长";d.orderPageJson.buyProductName=config.productName[d.itemValue];d.orderPageJson.buyProductCode=config.QQproductCode[d.itemValue];d.orderPageJson.buyNum=d.itemValue=="1015"?(d.buyMoney*1)+"Q币":parseInt(d.buyMoney*1).toString().replace("0","")+"个月";d.callQuickTradingQuery()};e.prototype.callQuickTradingQuery=function(){var g=this;b.callCPSService({service:config.CPS.QUICK_TRADING_QUERY,params:g.quickTradingQueryParams(),showLoading:false,success:g.quickTradingQuerySuccessCallback})};e.prototype.quickTradingQueryParams=function(){var g=this;var h={};h=b.setCPSCommonParams(h);return h};e.prototype.quickTradingQuerySuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){if(g.code=="006781"){Bestpay.Dialog.showAlertDialog(config.TITLE.dialog_title,"账户异常，请确认后再试","确定",g.code);return}Bestpay.Dialog.showAlertDialog(config.TITLE.dialog_title,g.content,"确定",g.code);return}d.quickTranInfo={perAmount:g.perAmount,allamount:g.allamount,alltransaction:g.alltransaction};d.handleIsneedpassword()};e.prototype.handleIsneedpassword=function(){var h=this.quickTranInfo;var g=f.yuan2fen(this.buyMoney);console.log("amount : "+g);console.log("quickTranInfo : "+JSON.stringify(h));if(g*1<=1*h.perAmount&&(g*1+1*h.alltransaction)<=1*h.allamount){d.noPwd=false}else{d.noPwd=true}console.log("rechargeSelf.userInfo.authenStatus=="+d.userInfo.authenStatus);if(d.userInfo.authenStatus=="A02"){console.log("rechargeSelf.userInfo.hadEpt  "+d.userInfo.hadEpt);if(d.userInfo.hadEpt==1){d.getFinancialProducts()}else{d.fundAccountBalanceInquiry()}}else{d.fundAccountBalanceInquiry()}};e.prototype.getFinancialProducts=function(){var g=this;b.callCPSService({service:config.CPS.FINANCIAL_PRODUCTS,params:g.getFinancialProductsParams(),showLoading:false,success:g.getFinancialProductsSuccessCallback})};e.prototype.getFinancialProductsParams=function(){var g=this;var h={};h=b.setCPSCommonParams(h);return h};e.prototype.getFinancialProductsSuccessCallback=function(i){if(i.code!==config.RES.SUCCESS){if(i.code==="018888"){d.fundAccountBalanceInquiry();return}else{Bestpay.Dialog.showAlertDialog("提醒",i.content,"确定",i.code);return}}var h=i.datas;for(var g=0;g<h.length;g++){d.orderPageJson.productId=h[g]["productId"];d.orderPageJson.userId=h[g]["userId"];d.orderPageJson.tyb_amount=f.fen2yuan(h[g]["balance"])}d.fundAccountBalanceInquiry()};e.prototype.fundAccountBalanceInquiry=function(){var g=this;b.callCPSService({service:config.CPS.CCOUNT_BALANCE_QUERY,params:g.fundAccountBalanceInquiryParams(),showLoading:false,success:g.fundAccountBalanceInquirySuccessCallback})};e.prototype.fundAccountBalanceInquiryParams=function(){var g=this;var h={bankMode:g.userInfo.bankMode};h=b.setCPSCommonParams(h);return h};e.prototype.fundAccountBalanceInquirySuccessCallback=function(l){if(l.code!==config.RES.SUCCESS){Bestpay.Dialog.showAlertDialog("提醒",l.content,"确定",l.code);return}console.log("资金账户余额查询 SAcc003出参======="+JSON.stringify(l));var o=l.dayLimit;var p=l.dayTotal;var r=o*1-p*1;var n=l.monthLimit;var i=l.monthTotal;var h=n*1-i*1;var k=l.motherBoard;var j=l.accountItems;for(var s=0;s<j.length;s++){var m=j[s]["acctType"];if(m!=null||m!="null"||m!="undefined"||m!=""){if("0007"==m){var q=j[s].activeBalance;d.orderPageJson.jfy_amount=f.fen2yuan(q);break}}}if(config.CARD_TYPE.BANK_MODE_FUND_POOL_MEMBER_CARD===d.userInfo.bankMode){var g="";if(o==="0"){g=k}else{if(k>r){g=r}else{g=k}}if(n==="0"){g=k}else{if(k>h){g=h}else{g=k}}d.orderPageJson.jfy_amount=f.fen2yuan(g);console.log("子卡＝＝"+d.orderPageJson.jfy_amount)}d.queryEnd()};e.prototype.setOrderDisplay=function(h){var j=this;var i=document.getElementById("code009002");if(h==="overtime"){i.style.display="block";d.successJson.acctCode=j.orderPageJson.contact;d.successJson.txnAmount=(j.buyMoney*1).toFixed(2);var g=new c.Template();g.template_OneToOne("id_success_item_overtime",j.successJson);goTo(config.page.float_dia);dismissDialog();console.log("self.payType=="+j.payType);if(j.payType=="1"){App.updateTybRereshFlag()}config.isBack=function(){if(window.jqXHR.readyState>2){Bestpay.App.exitApp()}}}if(h==="normal"){i.style.display="none"}};e.prototype.gotoOrder=function(g){b.getRandomServices(function(i){var h=i;if(i.code===config.RES.SUCCESS){d.random=i.randNum}d.rechargeResp(g)},false)};e.prototype.rechargeResp=function(h){var g=this;b.callCPSService({service:config.CPS.TTQQ003,params:g.rechargeParams(h),showLoading:true,success:g.rechargeSuccessCallback})};e.prototype.rechargeParams=function(h){var i=this;var j="";if(h!=null&&h!=""){j=h}i.orderPageJson.buyNum=parseInt(i.orderPageJson.buyNum);var g={phone:(i.mobile_val.replace(/\s/g,"")),orderSeq:b.getOrderSeq(),rechQuantity:i.orderPageJson.buyNum,rechAmount:(i.buyMoney*100).toFixed(0),productCode:i.orderPageJson.buyProductCode,acctCode:i.orderPageJson.contact,tradeTime:b.getOrderSeq(),supplyCode:i.orderPageJson.supplyCode};if(d.userInfo.hadEpt.toString()=="1"){g.costWay=i.paymentPlugin.getPayType();g.productId=i.productId;g.userId=d.orderPageJson.userId}console.log("充值接口出参== "+JSON.stringify(g));if(d.noPwd==true){g.password=Bestpay.Security.encryptPassword(i.userInfo.staffCode,j,i.random)}g=b.setCPSCommonParams(g);return g};e.prototype.rechargeSuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){if(g.code=="009002"||g.code=="006751"){d.paymentPlugin.setOrderDisplay("overtime");goTo(config.page.float_dia);return}if(g.code===config.RES.MONEY_NOT_ENOUGH){Bestpay.Dialog.showAlertDialog(config.TITLE.no_repeat,config.RES.MONEY_NOT_ENOUGH_MSG,"确定",g.code,function(h){back();d.itJudgeLocalStorage.putLocalValue("","","","")});return}else{if(g.code==config.RES.PASSWORD_ERROR_LOCKED_002136){Bestpay.Dialog.showAlertDialog(config.TITLE.no_repeat,g.content,"确定",g.code,function(){App.exitCompleteApp();d.itJudgeLocalStorage.putLocalValue("","","","")})}else{Bestpay.Dialog.showAlertDialog(config.TITLE.no_repeat,g.content,"确定",g.code,function(){back();d.itJudgeLocalStorage.putLocalValue("","","","")})}}return}d.itJudgeLocalStorage.putLocalValue("","","","");if(d.mobile_val.length>0){b.sendSmsCertificate(g.transSeq,d.mobile_val,"")}d.paymentPlugin.setOrderDisplay("success");goTo(config.page.float_dia);config.isBack=function(){if(window.jqXHR.readyState>2){Bestpay.App.exitApp()}}};e.prototype.queryStart=function(){var g=this;g.defferred=a.Deferred();showDialog()};e.prototype.queryEnd=function(){var g=this;console.log(JSON.stringify(g.orderPageJson));var h={businessName:g.businessName,accountName:"QQ充值",accouontValue:g.orderPageJson.contact,rechargeMoney:g.buyMoney,rewardType:g.orderPageJson.rewardType,rewardMoney:g.orderPageJson.reward,jfyBalance:g.orderPageJson.jfy_amount,tybBalance:g.orderPageJson.tyb_amount,enablePassword:g.noPwd,userInfo:g.userInfo,callback:g.gotoOrder};console.log("pluginParam = "+JSON.stringify(h));g.paymentPlugin=new c.paymentPlugin(h);dismissDialog();goTo(config.page.comfirm,function(){});g.defferred.resolve()};e.prototype.goPayAnimation=function(){console.log("done=========================");a("#order_comfirm").removeClass("backPayAnimation").addClass("goPayAnimation")};return e});