define(["jquery","bestpay.ui","bestpay.lang","bestpay.http"],function(b,d,a,c){var f=null;function e(){f=this;this.userInfo=JSON.parse(Bestpay.User.getSuccessLoginInfo());this.selectType=null;this.random=null;this.BROADBANDNUM="03010100";this.pecProductCode="00000007";this.phone_area=null;this.phone_number=null;this.phone_amount=null;this.isReload=true;this.itMobile=null;this.ipPassword=null;this.orderPageJson={};this.successJson={};this.payType="0";this.checkBillCheck=false;this.BroadbandData={};this.productId="0030001";this.paymentPlugin=null;this.businessName="电信固话"}e.prototype.initApp=function(){config.TRADE_LIST_QUERY_TYPE=config.BUS_TYPE.BUS_TYPE_FIXEDPHONEBROADBAND;var g=this;goTo(config.page.main,function(){console.log("--------------start--------------");var h=function(i){if(g.BROADBANDNUM!=i){g.hideMagDiv();g.phone_area.clearValue();g.phone_number.clearValue()}g.BROADBANDNUM=i;if(i=="03010100"){b("#phone_number").attr("placeholder","固话号码");b("#phone_number").attr("type","tel");b(".fixed-line").show();g.businessName="电信固话"}else{if(i=="03010200"){b("#phone_number").attr("placeholder","宽带号码");b("#phone_number").attr("type","text");b(".fixed-line").hide();g.businessName="电信宽带"}}};g.selectType=new d.BlockRadioGroup("brg_amount","item03010100",h);g.phone_area=new d.InputText("phone_area","number",function(){g.hideMagDiv()},function(){g.hideMagDiv()});g.phone_number=new d.InputText("phone_number",null,function(i){b("#id_confirm_amount").hide();b("#id_confirm_name").hide();if(g.BROADBANDNUM=="03010100"){g.phone_number.setValue(i.replace(/[^0-9]+/,""));i=g.phone_number.getToEmptyValue();if(i.length==0){b(g.phone_number.btnClear).hide()}}},function(){b("#id_confirm_amount").hide();b("#id_confirm_name").hide()});g.phone_number.blur(function(){setTimeout(function(){if(g.validaForm()==false){return}if(g.isReload==true){}g.extractsClientName()},11)});g.phone_area.blur(function(){b("#id_confirm_amount").hide();setTimeout(function(){if(g.phone_number_val!=null&&g.phone_number_val.length>=5){g.phone_area_val=g.phone_area.getToEmptyValue();if(g.phone_area_val==null||g.phone_area_val.length==0){Bestpay.Toast.makeText("请输入区号",Bestpay.Toast.LENGTH_SHORT);return false}else{if(g.phone_area_val.length<3||g.phone_area_val.length>5){Bestpay.Toast.makeText("请输入正确的区号",Bestpay.Toast.LENGTH_SHORT);return false}}if(g.isReload==true){g.extractsClientName()}}config.isOpen=true;g.extractsTheArea()},11)});g.phone_amount=new d.InputText("phone_amount","number");g.itMobile=new d.InputText("mobile","mobile");g.btnInit()})};e.prototype.btnInit=function(){var g=this;document.getElementById("btn_next").onclick=function(){g.checkBillCheck=false;g.validation()}};e.prototype.extractsTheArea=function(){var g=this;c.callCPSService({service:config.CPS.ExtractsTheArea,params:g.extractsTheAreaParams(),showLoading:false,success:g.extractsTheAreaSuccessCallback})};e.prototype.extractsTheAreaParams=function(){var g=this;var h={};h.areaCode=g.phone_area.getToEmptyValue();h=c.setCPSCommonParams(h);return h};e.prototype.extractsTheAreaSuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){Bestpay.Toast.makeText(g.content+"("+g.code+")",Bestpay.Toast.LENGTH_SHORT);return}if(g.provinceName==null||g.cityName==null||g.provinceName=="null"||g.cityName=="null"){return}f.orderPageJson.content=g.provinceName+"-"+g.cityName;f.orderPageJson.provinceCode=g.provinceCode;var h=new d.Template();h.template_OneToOne("id_msg",f.orderPageJson);f.showMagDiv();if(f.orderPageJson.amount_val==""||f.orderPageJson.amount_val==null){b("#id_confirm_amount").hide();b("#id_confirm_name").hide()}};e.prototype.extractsClientName=function(){var g=this;c.callCPSService({service:config.CPS.ExtractsClientName,params:g.extractsClientNameParams(),showLoading:false,success:g.extractsClientNameSuccessCallback})};e.prototype.extractsClientNameParams=function(){var g=this;var h={};h.telNum=g.phone_area.getToEmptyValue()+""+g.phone_number.getToEmptyValue();if(g.BROADBANDNUM=="03010100"){h.type="3"}else{if(g.BROADBANDNUM=="03010200"){h.type="2"}}h=c.setCPSCommonParams(h);return h};e.prototype.extractsClientNameSuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){Bestpay.Toast.makeText(g.content+"("+g.code+")",Bestpay.Toast.LENGTH_SHORT);return}if(g.custName==null||g.balance==null||g.custName=="null"||g.balance=="null"){return}f.orderPageJson.custName_val=g.custName;f.orderPageJson.amount_val=g.balance;var h=new d.Template();h.template_OneToOne("id_msg",f.orderPageJson);f.showMagDiv();b("#id_confirm_amount").show();b("#id_confirm_name").show();if(f.orderPageJson.provinceCode!=null&&f.orderPageJson.provinceCode!="510000"){b("#id_confirm_amount").hide();b("#id_confirm_name").hide()}};e.prototype.callQuickTradingQuery=function(){var g=this;c.callCPSService({service:config.CPS.QUICK_TRADING_QUERY,params:g.quickTradingQueryParams(),showLoading:false,success:g.quickTradingQuerySuccessCallback})};e.prototype.quickTradingQueryParams=function(){var g=this;var h={};h=c.setCPSCommonParams(h);return h};e.prototype.quickTradingQuerySuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){Bestpay.Dialog.showAlertDialog(config.TITLE.dialog_title,g.content,"确定",g.code);return}f.quickTranInfo={perAmount:g.perAmount,allamount:g.allamount,alltransaction:g.alltransaction};f.handleIsneedpassword()};e.prototype.handleIsneedpassword=function(){var i=this;var h=this.quickTranInfo;var g=a.yuan2fen(this.phone_amount_val);console.log("amount : "+g);console.log("quickTranInfo : "+JSON.stringify(h));if(g*1<=1*h.perAmount&&(g*1+1*h.alltransaction)<=1*h.allamount){b("#id_pwd_wrap").hide();f.noPwd=false}else{f.noPwd=true;b("#id_pwd_wrap").show()}console.log("self.userInfo.authenStatus=="+i.userInfo.authenStatus);if(i.userInfo.authenStatus=="A02"){console.log("self.userInfo.hadEpt  "+i.userInfo.hadEpt);if(i.userInfo.hadEpt==1){b("#tianyibao_pay").show();i.getFinancialProducts()}else{b("#tianyibao_pay").hide();i.fundAccountBalanceInquiry()}}else{b("#tianyibao_pay").hide();i.fundAccountBalanceInquiry()}};e.prototype.getFinancialProducts=function(){var g=this;c.callCPSService({service:config.CPS.FINANCIAL_PRODUCTS,params:g.getFinancialProductsParams(),showLoading:false,success:g.getFinancialProductsSuccessCallback})};e.prototype.getFinancialProductsParams=function(){var g=this;var h={};h=c.setCPSCommonParams(h);return h};e.prototype.getFinancialProductsSuccessCallback=function(i){if(i.code!==config.RES.SUCCESS){if(i.code==="018888"){f.fundAccountBalanceInquiry();return}else{Bestpay.Dialog.showAlertDialog("提醒",i.content,"确定",i.code);return}}b("#payfortianyibao").show();var h=i.datas;for(var g=0;g<h.length;g++){f.orderPageJson.productId=h[g]["productId"];f.orderPageJson.userId=h[g]["userId"];f.orderPageJson.tyb_amount=a.fen2yuan(h[g]["balance"])}f.checkBill(f.orderPageJson.tyb_amount,"tyb",1);if(f.checkBillCheck){return}f.fundAccountBalanceInquiry()};e.prototype.fundAccountBalanceInquiry=function(){var g=this;c.callCPSService({service:config.CPS.CCOUNT_BALANCE_QUERY,params:g.fundAccountBalanceInquiryParams(),showLoading:false,success:g.fundAccountBalanceInquirySuccessCallback})};e.prototype.fundAccountBalanceInquiryParams=function(){var g=this;var h={bankMode:g.userInfo.bankMode};h=c.setCPSCommonParams(h);return h};e.prototype.fundAccountBalanceInquirySuccessCallback=function(l){if(l.code!==config.RES.SUCCESS){Bestpay.Dialog.showAlertDialog("提醒",l.content,"确定",l.code);return}console.log("资金账户余额查询 SAcc003出参======="+JSON.stringify(l));var o=l.dayLimit;var p=l.dayTotal;var r=o*1-p*1;var n=l.monthLimit;var i=l.monthTotal;var h=n*1-i*1;var k=l.motherBoard;var j=l.accountItems;for(var s=0;s<j.length;s++){var m=j[s]["acctType"];if(m!=null||m!="null"||m!="undefined"||m!=""){if("0007"==m){var q=j[s].activeBalance;f.orderPageJson.jfy_amount=a.fen2yuan(q);break}}}if(config.CARD_TYPE.BANK_MODE_FUND_POOL_MEMBER_CARD===f.userInfo.bankMode){var g="";if(o==="0"){g=k}else{if(k>r){g=r}else{g=k}}if(n==="0"){g=k}else{if(k>h){g=h}else{g=k}}f.orderPageJson.jfy_amount=a.fen2yuan(g);console.log("子卡＝＝＝＝broadbandSelf.orderPageJson['jfy_amount']=="+f.orderPageJson.jfy_amount)}f.checkBill(f.orderPageJson.jfy_amount,"jfy",0);if(f.checkBillCheck){return}f.getCommission()};e.prototype.gotoChosePay=function(){var g=this;showDialog(config.MSG.loading);g.resetChoseData();goTo(config.page.pay,function(){dismissDialog();b(".main_wrap").each(function(){b(this).on("click",function(){var h=b(this).children(".radio_off");if(h.hasClass("radio_refresh")||h.hasClass("radio_loading")){return}b(".radio_on").removeClass("radio_on");h.addClass("radio_on");g.setChoseData(h.attr("data-value"))})})})};e.prototype.resetChoseData=function(){var g=this;var h=null;g.BroadbandData={};b(".radio_off").removeClass("radio_on");if(f.payType=="0"){h=b(".radio_off").eq(0);if(h.hasClass("radio_refresh")||h.hasClass("radio_loading")){return}b(".radio_off").eq(0).addClass("radio_on")}else{if(f.payType=="1"){h=b(".radio_off").eq(1);if(h.hasClass("radio_refresh")||h.hasClass("radio_loading")){return}b(".radio_off").eq(1).addClass("radio_on")}}};e.prototype.setChoseData=function(h){var g=this;if(h=="0"){g.BroadbandData.payType="0";g.BroadbandData.font="余额付款"}else{if(h=="1"){g.BroadbandData.payType="1";g.BroadbandData.font="添益宝账户余额付款"}}};e.prototype.sureData=function(){var g=this;if(g.BroadbandData.payType=="0"||g.BroadbandData.payType=="1"){f.payType=g.BroadbandData.payType;b(".chosebill span").html(g.BroadbandData.font)}console.log("payType========================="+f.payType);back()};e.prototype.checkBill=function(h,g,j){var i=this};e.prototype.validation=function(){this.phone_area_val=this.phone_area.getToEmptyValue();this.phone_number_val=this.phone_number.getToEmptyValue();this.mobile_val=this.itMobile.getToEmptyValue();this.phone_amount_val=this.phone_amount.getToEmptyValue();var g=this;if(g.validaForm()==false){return}else{if(this.phone_amount_val==null||this.phone_amount_val.length==0){Bestpay.Toast.makeText("请输入充值金额",Bestpay.Toast.LENGTH_SHORT);return}else{if(this.phone_amount_val*1<5||this.phone_amount_val*1>2000){Bestpay.Toast.makeText("请输入5到2000元的整数金额",Bestpay.Toast.LENGTH_SHORT);return}}}if(this.mobile_val.length>=1&&this.mobile_val.length<11){Bestpay.Toast.makeText("请输入11位的顾客手机号码",Bestpay.Toast.LENGTH_SHORT);return}if(g.isReload==true){Bestpay.Toast.makeText("请重新填写固话/宽带号码",Bestpay.Toast.LENGTH_SHORT);return}g.orderPageJson.phone_area_val=this.phone_area_val;g.orderPageJson.phone_number_val=this.phone_number_val;g.orderPageJson.phone_amount_val=(this.phone_amount_val*1).toFixed(2);if(g.BROADBANDNUM=="03010100"){g.orderPageJson.ServiceName="固话号码"}else{if(g.BROADBANDNUM=="03010200"){g.orderPageJson.ServiceName="宽带号码"}}g.itJudgeLocalStorage=new d.JudgeLocalStorage();g.itJudgeLocalStorage.checkOrder(g.phone_area_val+"-"+g.phone_number_val,g.phone_amount_val*1,c.getCurrentTime(),function(){showDialog(config.MSG.loading);f.defferred=b.Deferred();f.defferred.done(g.goPayAnimation);f.getVerifyResp()},g.businessName)};e.prototype.validaForm=function(){var g=this;g.phone_area_val=g.phone_area.getToEmptyValue();g.phone_number_val=g.phone_number.getToEmptyValue();config.isOpen=true;if(g.phone_area_val==null||g.phone_area_val.length==0){Bestpay.Toast.makeText("请输入区号",Bestpay.Toast.LENGTH_SHORT);return false}else{if(g.phone_area_val.length<3||g.phone_area_val.length>5){Bestpay.Toast.makeText("请输入正确的区号",Bestpay.Toast.LENGTH_SHORT);return false}else{if(g.phone_number_val==null||g.phone_number_val.length==0){Bestpay.Toast.makeText("请输入号码",Bestpay.Toast.LENGTH_SHORT);return false}else{if((g.phone_area_val+""+g.phone_number_val).length>64){Bestpay.Toast.makeText("充值号码长度不能大于64位",Bestpay.Toast.LENGTH_SHORT);return false}else{if(g.phone_number_val.length<5){Bestpay.Toast.makeText("请输入正确固话/宽带号",Bestpay.Toast.LENGTH_SHORT);return false}}}}}return true};e.prototype.initConfirm=function(){var j=this;var h=j.orderPageJson.custName_val;var k=j.orderPageJson.amount_val;var g=j.orderPageJson.ifrefush;var i=j.orderPageJson.queryType;if(i=="Y"){if(g=="Y"){b("#payName_parent_img").show()}else{b("#payName_parent_img").hide()}}else{b("#id_confirm_name").hide()}b("#payName_parent_img").on("click",function(){j.getVerifyResp()});j.queryEnd()};e.prototype.getVerifyResp=function(){var g=this;c.callCPSService({service:config.CPS.RECHARE_ACCOUNT_VERIFY,params:g.getVerifyRespParams(),showLoading:false,success:g.getVerifyRespSuccessCallback})};e.prototype.getVerifyRespParams=function(){this.phone_area_val=this.phone_area.getToEmptyValue();this.phone_number_val=this.phone_number.getToEmptyValue();var g=3;if(this.BROADBANDNUM=="03010100"){self.pecProductCode="00000007";g=3}else{if(this.BROADBANDNUM=="03010200"){self.pecProductCode="00000006";g=2}}var h={verify:g,isQryUserInfo:"Y",queryQuantity:"1",accepTareaCode:this.phone_area_val,acctCode:this.phone_area_val+""+this.phone_number_val,reamount:0,acceptDate:a.getDate_YYYYMMDD(),acceptTime:a.getTime_HHMMSS()};h=c.setCPSCommonParams(h);return h};e.prototype.getVerifyRespSuccessCallback=function(g){b("#payamout_parent_img").attr("src","../lib/img/ic_refresh.png");if(g.code!==config.RES.SUCCESS){Bestpay.Dialog.showAlertDialog(config.TITLE.dialog_title,g.content+"("+g.code+")","确定","");return}f.orderPageJson.systemNo=g.systemNo;f.orderPageJson.tradeSeq=g.tradeSeq;f.orderPageJson.flag=g.flag;f.orderPageJson.queryType=g.queryType;f.orderPageJson.reward="0.00";f.orderPageJson.custName_val=g.custName;f.orderPageJson.amount_val=g.amount;f.orderPageJson.ifrefush=g.ifrefush;var h=g.ifrefush;var i=g.queryType;console.log("ifrefush=="+h);console.log("ifrefush=="+i);f.callQuickTradingQuery()};e.prototype.queryEnd=function(){var g=this;var h={businessName:g.businessName,accountName:"固话宽带",accouontValue:g.orderPageJson.phone_area_val+"-"+g.orderPageJson.phone_number_val,rechargeMoney:g.orderPageJson.phone_amount_val,rewardType:g.orderPageJson.rewardType,rewardMoney:g.orderPageJson.reward,jfyBalance:g.orderPageJson.jfy_amount,tybBalance:g.orderPageJson.tyb_amount,enablePassword:g.noPwd,userInfo:g.userInfo,callback:g.gotoOrder};console.log("pluginParam = "+JSON.stringify(h));g.paymentPlugin=new d.paymentPlugin(h);g.payType=g.paymentPlugin.getPayType();console.log("支付方式=="+g.payType);dismissDialog();goTo(config.page.comfirm,function(){});g.defferred.resolve()};e.prototype.goPayAnimation=function(){console.log("done=========================");b("#order_comfirm").removeClass("backPayAnimation").addClass("goPayAnimation")};e.prototype.gotoOrder=function(g){config.TRADE_LIST_QUERY_NUMBER=f.orderPageJson.phone_area_val+""+f.orderPageJson.phone_number_val;c.getRandomServices(function(i){var h=i;if(i.code===config.RES.SUCCESS){f.random=i.randNum}f.rechargeResp(g)},false)};e.prototype.showMagDiv=function(){b("#id_msg_show").show();b("#img_posting").hide();var g=f;g.isReload=false};e.prototype.hideMagDiv=function(){b("#id_msg_show").hide();b("#img_posting").hide();var g=f;g.orderPageJson.custName_val="";g.orderPageJson.amount_val="";g.phone_amount.clearValue();g.isReload=true};e.prototype.getCommission=function(){var g=this;var h=f.orderPageJson.phone_area_val+""+f.orderPageJson.phone_number_val;c.getCommission(config.BUS_TYPE.BUS_TYPE_FIXEDPHONEBROADBAND,g.BROADBANDNUM,g.BROADBANDNUM,g.phone_amount_val,function(i){var j=i;if(i.code===config.RES.SUCCESS){j.commission=a.fen2yuan(i.reward)}else{if(i.code===config.CODE.COMMOSSION_ERROR){j.code=config.RES.SUCCESS;j.commission="0.00"}else{j.code=config.RES.UNKNOWN_ERROR;j.content=config.RES.UNKNOWN_ERROR_MSG}}f.orderPageJson.reward=j.commission;f.orderPageJson.rewardType="reward";f.orderPageJson.supplyCode=j.supplyCode;f.initConfirm()},false,"",g.pecProductCode,h)};e.prototype.gotoRecharge=function(){this.mobile_val=this.itMobile.getToEmptyValue();if(this.mobile_val.length>=1&&this.mobile_val.length<11){Bestpay.Toast.makeText("请输入11位的顾客手机号码",Bestpay.Toast.LENGTH_SHORT);return}else{if(this.mobile_val.length==11&&!this.itMobile.getInputCheck()){Bestpay.Toast.makeText("您输入的手机号号码段不正确",Bestpay.Toast.LENGTH_SHORT);return}}if(this.noPwd){Bestpay.Toast.makeText("请输入您的支付密码",Bestpay.Toast.LENGTH_SHORT)}showDialog(config.MSG.loading);config.TRADE_LIST_QUERY_NUMBER=f.orderPageJson.phone_area_val+""+f.orderPageJson.phone_number_val;config.isBack=function(){back()};c.getRandomServices(function(g){var h=g;if(g.code===config.RES.SUCCESS){f.random=g.randNum}f.rechargeResp()},false)};e.prototype.rechargeResp=function(h){var g=this;c.callCPSService({service:config.CPS.TBRB_CHARGE,params:g.rechargeParams(h),showLoading:true,success:g.rechargeSuccessCallback})};e.prototype.rechargeParams=function(h){var i=this;var j="";if(h!=null&&h!=""){j=h}var g={acceptAreaCode:i.orderPageJson.phone_area_val,acctCode:i.orderPageJson.phone_area_val+""+i.orderPageJson.phone_number_val,busiCode:i.BROADBANDNUM,orderSeq:i.orderPageJson.tradeSeq,payPassWord:Bestpay.Security.encryptPassword(i.userInfo.staffCode,j,i.random),systemNo:i.orderPageJson.systemNo,tradeTime:a.getDate_YYYYMMDD()+""+a.getTime_HHMMSS(),txnAmount:a.yuan2fen(i.orderPageJson.phone_amount_val),supplyCode:i.orderPageJson.supplyCode};if(i.mobile_val!=null&&i.mobile_val.length>0){g.phone=i.mobile_val}else{g.phone=""}if(i.userInfo.hadEpt.toString()=="1"){g.costWay=i.paymentPlugin.getPayType();g.productId=i.productId;g.userId=i.orderPageJson.userId}g=c.setCPSCommonParams(g);return g};e.prototype.rechargeSuccessCallback=function(g){PasswordKeyBoard.hideKeyboardUI3();if(g.code!==config.RES.SUCCESS){if(g.code===config.RES.MONEY_NOT_ENOUGH){Bestpay.Dialog.showAlertDialog(config.TITLE.no_repeat,config.RES.MONEY_NOT_ENOUGH_MSG,"确定",g.code,function(h){back();f.itJudgeLocalStorage.putLocalValue("","","","")});return}if(g.code=="009002"||g.code=="006751"){f.paymentPlugin.setOrderDisplay("overtime");goTo(config.page.float_dia);return}if(g.code==config.RES.PASSWORD_ERROR_LOCKED_002136){Bestpay.Dialog.showAlertDialog(config.TITLE.no_repeat,g.content,"确定",g.code,function(h){App.exitCompleteApp();f.itJudgeLocalStorage.putLocalValue("","","","")});return}Bestpay.Dialog.showAlertDialog(config.TITLE.dialog_title,g.content,"确定",g.code,function(h){back();f.itJudgeLocalStorage.putLocalValue("","","","")});console.log("-----------:"+g.content);return}f.itJudgeLocalStorage.putLocalValue("","","","");f.successJson.transSeq=g.transSeq;f.successJson.txnAmount=a.fen2yuan(g.txnAmount);f.successJson.amount=f.orderPageJson.phone_amount_val;f.successJson.contact=f.orderPageJson.phone_area_val+"-"+f.orderPageJson.phone_number_val;if(f.mobile_val.length>0){c.sendSmsCertificate(g.transSeq,f.mobile_val,"")}f.paymentPlugin.setOrderDisplay("success");goTo(config.page.float_dia);dismissDialog();config.isBack=function(){if(window.jqXHR.readyState>2){Bestpay.App.exitApp()}}};return e});