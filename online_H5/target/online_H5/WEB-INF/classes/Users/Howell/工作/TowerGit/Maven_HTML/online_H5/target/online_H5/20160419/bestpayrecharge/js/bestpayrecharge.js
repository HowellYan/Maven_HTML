define(["bestpay.ui","bestpay.lang","bestpay.http"],function(e,c,d){var a=null;function b(){a=this;this.userInfo=JSON.parse(Bestpay.User.getSuccessLoginInfo());console.log("userInfo============="+JSON.stringify(userInfo));this.brgAmount=null;this.cardAmount="50";this.idAcountItem="50";this.quickTranInfo={};this.payType="0";this.selectType=null;this.random=null;this.phone_amount=null;this.itMobile=null;this.ipPassword=null;this.orderPageJson={};this.successJson={};this.checkPhome=false;this.rechargeData={};this.productId="0030001";this.defferred=null;this.paymentPlugin="";this.noPwd="";this.businessName="翼支付充值"}b.prototype.initApp=function(){config.TRADE_LIST_QUERY_TYPE=config.BUS_TYPE.BUS_TYPE_PERSON_ACCOUNT;var f=this;goTo(config.page.main,function(){var g=function(k){if(k.length==11){var i=document.getElementById("Mobile");var j=i.value;i.focus();i.value="";i.value=j;a.phoneNumber=k;a.phonetrueoffalse=false;a.getVerifyResp()}else{$("#custNameDiv").hide()}};var h=function(){f.brgAmount.setDisabled(false);f.phoneNumber=null;f.other_money=null};f.itMobile=new e.InputText("Mobile","phone",g,h);f.btnInit()})};b.prototype.btnInit=function(){var f=this;document.getElementById("btn_next").onclick=function(){f.getCommission()};f.selectMoney=function(){var i=this;goTo(config.page.id_Acount);var g={"10":"10","30":"30","50":"50","100":"100","200":"200","其他金额":"0"};var h=new e.dropDownBox("page_id_Acount",this,g,function(k,j){f.idAcountItem=k;if(k=="0"){$("#select_amount_list").hide();$("#phone_amount").show();back();i.onclick=null;return}$("#select_amount_list").show();$("#phone_amount").hide();f.phone_amount.clearValue();h.hideDropDownBox();f.idAcountHtml=$(j).html();$("#AccountSpan").html(f.idAcountHtml+"元");back()},function(){h.hideDropDownBox();back()})};f.phone_amount=new e.InputText("phone_amount","number",function(g){if(g.length==0){document.getElementById("btn_Account_down").onclick=f.selectMoney;document.getElementById("btn_Account_down").onclick()}},function(){document.getElementById("btn_Account_down").onclick=f.selectMoney});document.getElementById("btn_Account_down").onclick=f.selectMoney};b.prototype.callQuickTradingQuery=function(){var f=this;d.callCPSService({service:config.CPS.QUICK_TRADING_QUERY,params:f.quickTradingQueryParams(),showLoading:false,success:f.quickTradingQuerySuccessCallback})};b.prototype.quickTradingQueryParams=function(){var f=this;var g={};g=d.setCPSCommonParams(g);return g};b.prototype.quickTradingQuerySuccessCallback=function(f){if(f.code!==config.RES.SUCCESS){Bestpay.Dialog.showAlertDialog("提醒",f.content,"确定",f.code);return}a.quickTranInfo={perAmount:f.perAmount,allAmount:f.allamount,allTransAction:f.alltransaction};a.handleIsneedpassword()};b.prototype.handleIsneedpassword=function(){var g=this.quickTranInfo;var f=c.yuan2fen(this.cardAmount);console.log("amount : "+f);console.log("quickTranInfo : "+JSON.stringify(g));if(f*1<=1*g.perAmount&&(f*1+1*g.allTransAction)<=1*g.allAmount){a.noPwd=false}else{a.noPwd=true}console.log("BestpayCardSelf.userInfo.authenStatus=="+a.userInfo.authenStatus);if(a.userInfo.authenStatus=="A02"){console.log("BestpayCardSelf.userInfo.hadEpt  "+a.userInfo.hadEpt);if(a.userInfo.hadEpt==1){a.getFinancialProducts()}else{a.fundAccountBalanceInquiry()}}else{a.fundAccountBalanceInquiry()}};b.prototype.getVerifyResp=function(){var f=this;d.callCPSService({service:config.CPS.RECHARE_ACCOUNT_VERIFY,params:f.getVerifyRespParams(),showLoading:true,success:f.getVerifyRespSuccessCallback})};b.prototype.getVerifyRespParams=function(){var f=this;var g=0;var h={verify:g,acctCode:f.phoneNumber,isQryUserInfo:"Y",reamount:c.yuan2fen(this.cardAmount),acceptDate:c.getDate_YYYYMMDD(),acceptTime:c.getTime_HHMMSS()};h=d.setCPSCommonParams(h);return h};b.prototype.getVerifyRespSuccessCallback=function(f){if(f.code!==config.RES.SUCCESS){if(f.code=="006792"){f.content=config.CODE.VAL0_006792}Bestpay.Dialog.showAlertDialog("提醒",f.content,"确定",f.code);a.checkPhome=false;return}a.checkPhome=true;a.orderPageJson.content=f.content;a.orderPageJson.systemNo=f.systemNo;a.orderPageJson._tradeSeq=f.tradeSeq;a.orderPageJson.flag=f.flag;a.orderPageJson.custName=f.custName;a.orderPageJson.amount=f.amount;a.orderPageJson.queryType=f.queryType;a.orderPageJson.ifrefush=f.ifrefush;if(!f.custName){$("#custNameDiv").hide();$("#custNameitemGray").text("")}else{$("#custNameDiv").show();$("#custNameitemGray").text(f.custName)}};b.prototype.getFinancialProducts=function(){var f=this;d.callCPSService({service:config.CPS.FINANCIAL_PRODUCTS,params:f.getFinancialProductsParams(),showLoading:false,success:f.getFinancialProductsSuccessCallback})};b.prototype.getFinancialProductsParams=function(){var f=this;var g={};g=d.setCPSCommonParams(g);return g};b.prototype.getFinancialProductsSuccessCallback=function(f){if(f.code!==config.RES.SUCCESS){if(f.code==="018888"){a.fundAccountBalanceInquiry();return}else{Bestpay.Dialog.showAlertDialog("提醒",f.content,"确定",f.code);return}}var h=f.datas;for(var g=0;g<h.length;g++){a.orderPageJson.productId=h[g]["productId"];a.orderPageJson.userId=h[g]["userId"];a.orderPageJson.tyb_amount=c.fen2yuan(h[g]["balance"])}a.fundAccountBalanceInquiry()};b.prototype.fundAccountBalanceInquiry=function(){var f=this;d.callCPSService({service:config.CPS.CCOUNT_BALANCE_QUERY,params:f.fundAccountBalanceInquiryParams(),showLoading:false,success:f.fundAccountBalanceInquirySuccessCallback})};b.prototype.fundAccountBalanceInquiryParams=function(){var f=this;var g={bankMode:f.userInfo.bankMode};g=d.setCPSCommonParams(g);console.log("资金账户余额查询 SAcc003入参======="+JSON.stringify(g));return g};b.prototype.fundAccountBalanceInquirySuccessCallback=function(s){if(s.code!==config.RES.SUCCESS){Bestpay.Dialog.showAlertDialog("提醒",s.content,"确定",s.code);return}console.log("资金账户余额查询 SAcc003出参======="+JSON.stringify(s));var q=s.dayLimit;var g=s.dayTotal;var j=q*1-g*1;var f=s.monthLimit;var m=s.monthTotal;var l=f*1-m*1;var o=s.motherBoard;var n=s.accountItems;for(var k=0;k<n.length;k++){var p=n[k]["acctType"];if(p!=null||p!="null"||p!="undefined"||p!=""){if("0007"==p){var h=n[k].activeBalance;a.orderPageJson.jfy_amount=c.fen2yuan(h);console.log("普通卡＝＝BestpayCardSelf.orderPageJson['jfy_amount']=="+a.orderPageJson.jfy_amount);break}}}if(config.CARD_TYPE.BANK_MODE_FUND_POOL_MEMBER_CARD===a.userInfo.bankMode){var r="";if(q==="0"){r=o}else{if(o>j){r=j}else{r=o}}if(f==="0"){r=o}else{if(o>l){r=l}else{r=o}}a.orderPageJson.jfy_amount=c.fen2yuan(r);console.log("子卡＝＝＝＝"+a.orderPageJson.jfy_amount)}a.queryEnd()};b.prototype.getCommission=function(){var f=this;f.cardAmount=f.idAcountItem;this.mobile_val=this.itMobile.getToEmptyValue();if(this.mobile_val==""){Bestpay.Toast.makeText("请输入手机号码",Bestpay.Toast.LENGTH_SHORT);return}else{if(this.mobile_val.length>=1&&this.mobile_val.length<11){Bestpay.Toast.makeText("请输入11位的顾客手机号码",Bestpay.Toast.LENGTH_SHORT);return}else{if(a.checkPhome==false){Bestpay.Toast.makeText("请重新输入手机号码",Bestpay.Toast.LENGTH_SHORT);return}}}if(f.idAcountItem=="0"){f.cardAmount=f.phone_amount.getToEmptyValue();if(f.phone_amount.getToEmptyValue().length==0||f.phone_amount.getToEmptyValue()<5||f.phone_amount.getToEmptyValue()>1000){Bestpay.Toast.makeText("请输入5到1000元的整数金额",Bestpay.Toast.LENGTH_SHORT);return}}console.log("酬金查询");f.itJudgeLocalStorage=new e.JudgeLocalStorage();f.itJudgeLocalStorage.checkOrder(f.mobile_val,f.cardAmount*1,d.getCurrentTime(),function(){console.log(" self.mobile_val = "+f.mobile_val);console.log(" self.cardAmount = "+f.cardAmount);f.queryStart();f.defferred.done(f.goPayAnimation);f.orderPageJson.contact=f.mobile_val.replace(/(\d{3})(\d{4})/g,"$1 $2 ");f.orderPageJson.cardAmount=(f.cardAmount*1).toFixed(2);d.getCommission(config.BUS_TYPE.BUS_TYPE_PERSON_ACCOUNT,config.BUS_CODE.PERSON_ACCOUNT,config.BUS_CODE.PERSON_ACCOUNT,f.cardAmount,function(g){var h=g;if(g.code===config.RES.SUCCESS){h.commission=c.fen2yuan(g.reward)}else{if(g.code===config.CODE.COMMOSSION_ERROR){h.code=config.RES.SUCCESS;h.commission="0.00"}else{h.code=config.RES.UNKNOWN_ERROR;h.content=config.RES.UNKNOWN_ERROR_MSG}}f.orderPageJson.reward=h.commission;a.callQuickTradingQuery()},false)},f.businessName)};b.prototype.queryStart=function(){var f=this;f.defferred=$.Deferred();showDialog()};b.prototype.queryEnd=function(){var f=this;console.log("self.noPwd="+f.noPwd);var g={businessName:f.businessName,accountName:"翼支付充值",accouontValue:f.mobile_val,rechargeMoney:f.cardAmount,rewardMoney:f.orderPageJson.reward,jfyBalance:f.orderPageJson.jfy_amount,tybBalance:f.orderPageJson.tyb_amount,enablePassword:f.noPwd,userInfo:f.userInfo,callback:f.gotoOrder};console.log("pluginParam = "+JSON.stringify(g));f.paymentPlugin=new e.paymentPlugin(g);dismissDialog();goTo(config.page.comfirm,function(){});f.defferred.resolve()};b.prototype.goPayAnimation=function(){$("#order_comfirm").removeClass("backPayAnimation").addClass("goPayAnimation")};b.prototype.gotoOrder=function(f){d.getRandomServices(function(g){var h=g;if(g.code===config.RES.SUCCESS){a.random=g.randNum}a.rechargeResp(f)},false)};b.prototype.rechargeResp=function(g){var f=this;d.callCPSService({service:config.CPS.TACCCHARGE,params:f.rechargeParams(g),showLoading:true,success:f.rechargeSuccessCallback,error:f.rechargeErrorCallback})};b.prototype.rechargeParams=function(i){var f=this;var g="";if(i!=null&&i!=""){g=i}var h={costWay:f.paymentPlugin.getPayType(),orderSeq:a.orderPageJson._tradeSeq,acctCode:f.mobile_val,txnAmount:c.yuan2fen(f.orderPageJson.cardAmount),systemNO:f.orderPageJson.systemNo,acceptDate:c.getDate_YYYYMMDD()+""+c.getTime_HHMMSS(),payType:"0",operUser:f.userInfo.staffCode,operPassword:Bestpay.Security.encryptPassword(f.userInfo.staffCode,g,f.random)};console.log("self.payType"+f.payType);console.log("self.orderPageJson[userId] 666 "+f.orderPageJson.userId);if(f.userInfo.hadEpt.toString()=="1"){h.productId=f.productId;h.userId=f.orderPageJson.userId;console.log("self.orderPageJson[userId] 666 xxxx"+f.orderPageJson.userId)}h=d.setCPSCommonParams(h);console.log("翼支付充值 TTrdAcc003入参======="+JSON.stringify(h));return h};b.prototype.rechargeSuccessCallback=function(f){PasswordKeyBoard.hideKeyboardUI3();if(f.code!==config.RES.SUCCESS){if(f.code=="009002"||f.code=="006751"){a.paymentPlugin.setOrderDisplay("overtime");goTo(config.page.float_dia);return}if(f.code==config.RES.PASSWORD_ERROR_LOCKED_002136){Bestpay.Dialog.showAlertDialog("提醒",f.content,"确定",f.code,function(){App.exitCompleteApp();a.itJudgeLocalStorage.putLocalValue("","","","")})}else{Bestpay.Dialog.showAlertDialog("提醒",f.content,"确定",f.code,function(){back();a.itJudgeLocalStorage.putLocalValue("","","","")})}return}a.itJudgeLocalStorage.putLocalValue("","","","");console.log("翼支付充值 TTrdAcc003出参========"+JSON.stringify(f));d.sendSmsCertificate(f.transSeq,a.mobile_val,"");a.paymentPlugin.setOrderDisplay("success");goTo(config.page.float_dia);config.isBack=function(){if(window.jqXHR.readyState>2){Bestpay.App.exitApp()}}};b.prototype.rechargeErrorCallback=function(f){if(f.code===config.RES.MONEY_NOT_ENOUGH){Bestpay.Dialog.showAlertDialog("提醒","余额不足","确定",config.RES.MONEY_NOT_ENOUGH_MSG,function(){back();a.itJudgeLocalStorage.putLocalValue("","","","")});return}};return b});