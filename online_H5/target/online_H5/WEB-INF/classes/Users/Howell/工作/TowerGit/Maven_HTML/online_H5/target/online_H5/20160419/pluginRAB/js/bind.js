define(["utils","jquery"],function(e,k){var f=User.getProduct();var m=User.getSuccessLoginInfo();if(androidOrIos=="ios"){m=User.getSuccessLoginInfo()}else{m=JSON.parse(User.getSuccessLoginInfo())}var w=m.staffCode;var C=m.custCode;var c=m.prtnCode;var d=e.getUtilParams();var z=d.clientVersion;var x=d.systemType;console.log("111clientVersion  = "+z);console.log("111systemType = "+x);z=z.replace(/\./g,"")*1;x=x.toLowerCase();console.log("111clientVersion  = "+z);console.log("111systemType = "+x);var h=false;if(m.bindCard=="1"){Toast.makeText("该账户已经绑卡",1000);App.exitApp();return}var p="1";var u=new Array();k(function(){e.showDialog("请稍等..");i();console.log("click init");q();setTimeout(function(){e.dismissDialog()},2000);n()});function n(){k(":input").each(function(){k(this).focus(function(){k(this.parentNode.parentNode.parentNode).addClass("selectInputDiv");k(this.parentNode.parentNode.parentNode).removeClass("noselectInputDiv")});k(this).blur(function(){k(this.parentNode.parentNode.parentNode).removeClass("selectInputDiv");k(this.parentNode.parentNode.parentNode).addClass("noselectInputDiv")})});k("#quickBankPrePhone").on("input",function(){var G=k(this).val();k(this).val(k(this).val().replace(/[^0-9]+/,""));if(G.length>0){k("#id_clearPhone").show();k("#id_clearPhone").click(function(){k(this).hide();k("#quickBankPrePhone").val("")})}else{k("#id_clearPhone").hide()}});k("#bangBankPrePhone").on("input",function(){var G=k(this).val();k(this).val(k(this).val().replace(/[^0-9]+/,""));if(G.length>0){k("#id_clearbangBankPrePhone").show();k("#id_clearbangBankPrePhone").click(function(){k(this).hide();k("#bangBankPrePhone").val("")})}else{k("#id_clearbangBankPrePhone").hide()}});k("#msgVerifyCode").on("input",function(){var G=k(this).val();k(this).val(k(this).val().replace(/[^0-9]+/,""));if(G.length>0){k("#id_verifyCodePhone").show();k("#id_verifyCodePhone").click(function(){k(this).hide();k("#msgVerifyCode").val("")})}else{k("#id_verifyCodePhone").hide()}});k("#openBankBranchInfo").on("input",function(){var G=k(this).val();if(G.length>0){k("#id_clearopenBankBranchInfo").show();k("#id_clearopenBankBranchInfo").click(function(){k(this).hide();k("#openBankBranchInfo").val("")})}else{k("#id_clearopenBankBranchInfo").hide()}});k("#startBankCode").blur(function(){var G=k(this).val();if(!isNaN(G.replace(/\s/g,""))){k(this).val(G.replace(/\s/g,"").replace(/(\d{4})(?=\d)/g,"$1 "))}});k("#startBankCode").focus(function(){var G=k(this).val();k(this).val(G.replace(/\s/g,""))})}function q(){var G=0;k("#selectBankDiv").width((k("#id_open_outDiv").width()+2)+"px");document.getElementById("startBankCode").addEventListener("input",function(){console.log("------------------"+k("#startBankCode").val());var H=k("#startBankCode").val().substring(k("#startBankCode").val().length-1,k("#startBankCode").val().length);var I=k("#startBankCode").val();I=I.replace(/\s+/g,"");G=k("#startBankCode").val().length;if(/^[a-zA-Z]+$/.test(I)){k("#startBankCode").val("");G=0;return}if(/[\u4E00-\u9FA5]/g.test(I)){k("#startBankCode").val("");G=0;return}if(/[^0-9]+/.test(H)||G>19){k("#startBankCode").val(k("#startBankCode").val().substring(0,k("#startBankCode").val().length-1));G-=1;return}if(I.length>0){k(this).next("img").css("display","block");k(this).next("img").click(function(){k("#startBankCode").val("");k(this).css("display","none")})}else{k(this).next("img").css("display","none")}},false);k("#showBankNoHelp").click(function(){e.alert("银行预留手机号是办理该银行卡时所填写的手机号码，没有预留、忘记预留手机号、手机已停用，请联系银行客服",function(){},"知道了")});k("#showBankNoHelp2").click(function(){e.alert("银行预留手机号是办理该银行卡时所填写的手机号码，没有预留、忘记预留手机号、手机已停用，请联系银行客服",function(){},"知道了")});document.getElementById("showBankNoPicParent").onclick=function(){console.log("TalkingData = ");if((x==="ios"&&z>=403)||(x==="android"&&z>=406)){TalkingData.onEventWithLabel("添加银行卡","OCR识别银行卡");Scanner.bankOCR(function(I){console.log("bankOCR resultData:"+I);k("#startBankCode").val(JSON.stringify(I).replace(/\"/g,""));if(k("#startBankCode").val().toString().trim()!=""){k("#bankCodeImg").show()}else{k("#bankCodeImg").hide()}k("#bottomText").show();var J=k("#startBankCode").val().replace(/\s+/g,"");var H=k("#startBankName").val();var K={};K.code=k("#selectBankNo").val().trim();t=e.getSQLiteData("CardList","queryRelevant",K);console.log("BankNoBinList --> "+JSON.stringify(t));if(!j(t,J,k("#selectBankNo").val())){return}})}};k("#selectBank_background").click(function(){e.back()});k("#bankCardPicDiv").click(function(){e.back()});k("#authareasShow").click(function(){console.log("选择地区！！");v="openBankPosition";l("authprovice","getProvinceData","provice",null,true)});k("[name=confirmFuWu]").click(function(){var H=k(this).children("span").html();console.log("-------------"+H);if(H=="0"){k(this).css("background","url(images/check_ok.png)");k(this).css("background-size","contain");k(this).children("span").html("1");console.log("ok")}else{k(this).css("background","url(images/check_no.png)");k(this).css("background-size","contain");k(this).children("span").html("0");console.log("on")}})}function i(){var I=e.getUtilParams();I.channelCode="20";I.staffCode=w;I.custCode=C;I.bisChannel=bisChannel;I.merId=c;I.keep=e.getKeep();var G=Security.getSign(I);I.sign=G;I.signVer="2";console.log("#########获取支持绑卡的银行列表入参="+JSON.stringify(I));e.showDialog("加载中..");var H=function(N){console.log("#########获取支持绑卡的银行列出参"+JSON.stringify(N));e.dismissDialog();if(N.code=="012109"){e.alert("亲，为了您的账户安全，请先进行认证或等候认证完成！");return}else{if(N.code==TOKENLOST){var K=function(){User.login(f)};e.alert("亲，为了您的账户安全，请重新进行登录！",K);return}else{if(N.code!="000000"){e.alert(N.content+" ("+N.code+")");return}}}var J=N.bankCardList.length;for(var L=0;L<J;L++){var M=N.bankCardList[L].stat;if(M===p){u[L]={bankCode:N.bankCardList[L].bankCode,bankName:N.bankCardList[L].bankName}}}g()};e.sendPostRequest(URL+Method.SCbk002,I,H,null)}function g(){var H=document.getElementById("selectBankDiv");console.log("supportBankList"+JSON.stringify(u));for(var G=0;G<u.length;G++){var J=document.createElement("div");J.className="containterborderall btop-none";H.appendChild(J);var I=document.createElement("div");I.className="ub line";I.setAttribute("bankCode",u[G].bankCode);I.setAttribute("bankName",u[G].bankName);I.innerHTML=u[G].bankName;I.onclick=function(){k("#startBankCode").val("");r(k(this).attr("bankCode"),k(this).attr("bankName"))};J.appendChild(I)}}var b;var F={};var A=null;function l(I,K,M,L,G){var H="";console.log(G);if(!G){k("#authdistrict").html(H);b=""}var N=DB_Data.getActionCode(K,JSON.stringify(L));console.log("地区出参 --> "+JSON.stringify(N));for(var J=0;J<N.length;J++){H+="<div style = 'text-align:center;width:100%;border:1px solid #e4d9d9 ; margin:0px;' class='proviceCity "+M+"'>"+N[J].name+"<span style='display:none;'>"+N[J].code+"</span></div>"}k("#"+I).html(H);if(G&&A!==null){k("#"+I).children().eq(A).css({background:"#F0801E",color:"#FFF"})}k("."+M).click(function(){if(I!="authcity"){l("authcity","getCityData()","city",{code:k(this).children("span").text()},false)}var O=k(this).text().replace(k(this).children("span").text(),"");if(I=="authprovice"){F.proviceName=O;document.title=O;App.setTitle(O)}else{F.cityName=O;document.title=F.proviceName+O;App.setTitle(F.proviceName+O)}if(I=="authcity"){b=k(this).children("span").text()}if(G){A=k(this).index()}k(this).css({background:"#F0801E",color:"#FFF"});k(this).siblings().css({background:"#ECECEC",color:"#000"});console.log("地区选择"+b+"  || "+F.proviceName+"-"+F.cityName)});if(I=="authprovice"){e.toNextPage("authselectdizPage")}}var v;k("#confirmCity").click(function(){if(b==null||b==""||b==undefined){Toast.makeText("请选择完整的地区！",LENGTHLONG);return}k("#"+v).val(F.proviceName+"-"+F.cityName);e.back()});var t=null;k("#bindCardPageNext").click(function(){if(!e.notEmptyVail("startBankName",ERROR.bankNameEmptyError,null)){return}if(!e.bankNoVail("startBankCode")){return}var I=k("#startBankCode").val().replace(/\s+/g,"");var H=k("#startBankName").val();var L={};L.code=k("#selectBankNo").val().trim();t=e.getSQLiteData("CardList","queryRelevant",L);console.log("BankNoBinList --> "+JSON.stringify(t));if(!j(t,I,k("#selectBankNo").val())){return}var K={staffCode:w,channelCode:"20",bisChannel:bisChannel,custCode:C,merId:c,tmnNum:"440106003094",keep:e.getKeep()};e.getDeviceInfo(K);var G=Security.getSign(K);K.sign=G;K.signVer="2";console.log("infoInit() 入参："+JSON.stringify((K)));e.showDialog("加载中..");var J=function(N){console.log("info:Method:Sreg003  出参： Result --> "+JSON.stringify(N));if(N.code==TOKENLOST){var M=function(){User.login(f)};e.alert("⊙_⊙,为了您的账户安全，请您重新登录。",M);e.dismissMDialog("ch_dialog");return}else{if(N.code!="000000"){e.alert("⊙_⊙网络不给力哦，请检查后再试哈");e.dismissMDialog("ch_dialog");return}}e.dismissDialog();console.log("------------------------prinType:+"+m.prinType);if(m.prinType=="PT901"){E(N.staffName,N.certNbr,H,I);return}var M=function(){e.back()};var O="";if(androidOrIos=="ios"){O=User.getSuccessLoginInfo()}else{O=JSON.parse(User.getSuccessLoginInfo())}productType=O.productType;console.log("authenStatus================="+N.authenStatus);console.log("productType================="+productType);if(N.authenStatus=="A01"&&productType!="3"){e.alert("⊙_⊙无法绑卡,您还未认证！请先进行认证！",M)}else{if(N.authenStatus=="A00"){}else{if(N.authenStatus=="A99"&&productType!="3"){e.alert("⊙_⊙无法绑卡,认证失败！请尝试再次认证或联系客服！",M)}}}E(N.staffName,N.certNbr,H,I)};e.sendPostRequest(URL+Method.SAcc001,K,J,null)});var a=[];var y=[];function j(P,K,H){console.log("---------------------code:"+H);a.length=0;y.length=0;var I="";if(K.length<=10){I=K}else{I=K.substr(0,10)}var O=P;var J=[];for(var M=3;M<=I.length;M++){y.length=0;J.length=0;for(var L=0;L<O.length;L++){if(I.indexOf(O[L].CARD_BIN.toString().substr(0,M))==0){y.push(O[L]);console.log("777(_bin_xs[j].CARD_BIN =="+(O[L].CARD_BIN));console.log("777 _bin_card"+I.toString().substr(0,M));if(O[L].CARD_BIN==I.toString().substr(0,M)){J.push(O[L])}console.log("777 BANK_NAME =="+O[L].BANK_NAME);k("#startBankName").val(O[L].BANK_NAME);H=O[L].BANK_CODE}}O=y.concat();console.log("sunte consolog"+J.length);if(J.length>0){a.length=0;a=J.concat()}}if(y.length==0&&a.length==0){k("#startBankName").val("");if(H==""){Toast.makeText("",LENGTHLONG)}else{Toast.makeText("您输入的银行帐号与开户银行不匹配",LENGTHLONG)}BankIsRight=false;return false}else{if(a.length==1){if(H==""){k("#selectBankNo").val(a[0].BANK_CODE);console.log("999 = "+k("#selectBankNo").val());H=a[0].BANK_CODE}if(H!==a[0].BANK_CODE){BankIsRight=false;Toast.makeText("您的卡号输入有误",LENGTHLONG);return false}if(K.length==a[0].card_bit){k("#selectBankNo").val(a[0].BANK_CODE);console.log("999 = "+k("#selectBankNo").val());H=a[0].BANK_CODE;BankIsRight=true;return true}else{BankIsRight=false;Toast.makeText("您的卡号输入有误",LENGTHLONG);return false}}else{if(a.length>1){var N=false;for(var M=0;M<a.length;M++){var G=a[M].CARD_BIN;var Q=a[M].card_bit;if(K.substr(0,G.length)==G&&K.length==Q){if(H!==a[M].BANK_CODE){BankIsRight=false;Toast.makeText("您的卡号输入有误",LENGTHLONG);return false}BankIsRight=true;N=true;break}}if(!N){BankIsRight=false;Toast.makeText("您的卡号输入有误",LENGTHLONG)}return N}}}}function E(I,H,G,J){$_id("yzPayMoney").style.display="none";if(B(G)=="0"||B(G)==1){$_id("quickConfirmBindCardButton").innerHTML="确定";if(B(G)==1){Dialog.showAlertTwoBtnDialog("提醒",'"亲，请先确认是否已开通银联在线无卡支付功能。',"确定","取消","",function(L){console.log("code");if(L=="1"){K()}});$_id("yzPayMoney").style.display="block"}else{K()}function K(){k("#quickBankName").html(k("#startBankName").val());k("#quickBankAccount").html(J);k("#quickCardholderName").html(I);k("#quickIdentityCardNum").html(H);k("#id_clearPhone").click();k("#id_verifyCodePhone").click();e.toNextPage("quickBindCardPage");clearInterval(D);o=30;k("#con_yan_zheng_ma").text("发送短信");h=false}}else{k("#bangBankName").val(G);k("#bangBankAccount").val(J);k("#bangCardholderName").val(I);k("#bangIdentityCardNum").val(H);k("#openBankPosition").val("");k("#openBankBranchInfo").val("");k("#bangBankPrePhone").val("");k("#id_clearbangBankPrePhone").hide();k("#id_clearopenBankBranchInfo").hide();e.toNextPage("bangFuTongBindCardPage");$_id("quickConfirmBindCardButton").innerHTML="下一步"}}k("#quickConfirmBindCardButton").click(function(){if(!e.phoneNumVail("quickBankPrePhone",ERROR.openBankPhoneEmptyError)){return}if(!h){Toast.makeText("请先下发短信验证码！",LENGTHLONG);return}if(!e.notEmptyVail("msgVerifyCode","请输入短信验证码！")){return}if(k("#quickConfirmFuWu").children("span").html()=="0"){Toast.makeText("请先阅读并同意服务协议！",LENGTHLONG);return}var H=k("#msgVerifyCode").val();var I=$_id("quickBankPrePhone").value;var J=k("#selectBankNo").val();var K=k("#startBankCode").val();K=K.replace(/\s+/g,"");var M={staffCode:w,operType:"1",veriCode:H,custCode:C,bankAcc:K,bankAddr:"",bankCode:J,phoneNum:I,channelCode:"20",merId:c,tmnNum:"440106003094",bisChannel:bisChannel,keep:e.getKeep()};e.getDeviceInfo(M);var G=Security.getSign(M);M.sign=G;M.signVer="2";console.log("快捷绑卡 入参 --> "+JSON.stringify(M));e.showDialog("正在提交您的信息..");var L=function(P){console.log("快捷绑卡 出参 --> "+JSON.stringify(P));e.dismissDialog();if(P.code=="012109"){e.alert("亲，为了您的账户安全，请先进行认证或等候认证完成！");return}else{if(P.code==TOKENLOST){var O=function(){User.login(f)};e.alert("亲，为了您的账户安全，请重新进行登录！",O);return}else{if(P.code!="000000"){e.alert(P.content+" ("+P.code+")");return}}}var N=function(){App.exitAppFromBandCard("1")};var Q=function(){App.exitAppFromBandCard("2");return};console.log("------------bankAcc------- "+K.substring(K.length-4,K.length));App.updateUserInfo("1");e.toNextPage("bandKaSuccess")};e.sendPostRequest(URL+Method.MBinCrd002,M,L,null)});document.getElementById("bangKaRecharge").onclick=function(){App.exitAppFromBandCard("1")};k("#bangNextPayBtn").click(function(){if(!e.notEmptyVail("openBankBranchInfo",ERROR.openBankZhiHangInfoEmptyError)){return}if(!e.phoneNumVail("bangBankPrePhone",ERROR.bankReservePhoneEmptyError)){return}if(b==null||b==""||b==undefined){Toast.makeText("请选择完整的地区！",LENGTHLONG);return}if(k("#bangConfirmFuWu").children("span").text()=="0"){Toast.makeText("请先阅读并同意服务协议！",LENGTHLONG);return}var J=k("#openBankBranchInfo").val();var M=k("#bangBankPrePhone").val();var M=k("#bangBankPrePhone").val();var L=b;var O=e.getKeep().substring(10,16);var G=k("#selectBankNo").val();var N=k("#startBankCode").val();N=N.replace(/\s+/g,"");var I=e.getUtilParams();I.verifyType="000";I.orderNo=e.getOrderSeq();I.staffCode=w;I.custCode=C;I.areaCode=L;I.phone=M;I.openBank=J;I.bankCode=G;I.bankAcct=N;I.channelCode="20";I.bisChannel=bisChannel;I.keep=e.getKeep();e.getDeviceInfo(I);var H=Security.getSign(I);I.sign=H;I.signVer="2";console.log("帮付通绑卡验证 入参 -->:"+JSON.stringify(I));e.showDialog("正在跳转，请稍等..");var K=function(Q){console.log("帮付通绑卡验证 出参 -->:"+JSON.stringify(Q));e.dismissDialog();if(Q.code=="012109"){e.alert("亲，为了您的账户安全，请先进行认证或等候认证完成！");return}else{if(Q.code==TOKENLOST){var P=function(){User.login(f)};e.alert("亲，为了您的账户安全，请重新进行登录！",P);return}else{if(Q.code!="000000"){e.alert(Q.content+" ("+Q.code+")");return}}}var R=Q.forwardUrl;var U=Q.orderNo;var S=N;var T=function(){};App.startBangfutongActivity(R,U,S)};e.sendPostRequest(URL+Method.MBinCrd001,I,K,null)});k("[name = paymentServiceAgreement]").click(function(){var G=k("#serviceProtocalPage").setTemplateURL("tpl/WithholdingAgreement_v1.0.html");G.processTemplate({});e.toNextPage("serviceProtocalPage")});k("#showSupportBankListButton").click(function(){e.toNextPage("supportBankListPage")});k("#selectStartBankName").click(function(){e.toNextPage("selectBankDiv");App.setTitle("请选择开户银行")});var o=30;k("#con_yan_zheng_ma").click(function(){s()});var D;function s(){if(!e.phoneNumVail("quickBankPrePhone",ERROR.openBankPhoneEmptyError)){return}if(o!=30||k("#con_yan_zheng_ma").text()=="获取中..."){Toast.makeText("请稍等...",LENGTHLONG);return}k("#con_yan_zheng_ma").text("获取中...");clearInterval(D);var I=$_id("quickBankPrePhone").value;var K=k("#selectBankNo").val();var L=k("#startBankCode").val();L=L.replace(/\s+/g,"");console.log("------------bankAcc------- "+L.substring(L.length-4,L.length));console.log("999 = "+K);console.log("999 = "+k("#selectBankNo").val());var M={staffCode:w,operType:"0",bankCode:k("#selectBankNo").val(),custCode:C,bankAcc:L,phoneNum:I,channelCode:"20",merId:c,keep:e.getKeep(),bisChannel:bisChannel,tmnNum:"440106003094"};e.getDeviceInfo(M);var G=Security.getSign(M);M.sign=G;M.signVer="2";console.log("#########绑卡获取短信验证码入参："+JSON.stringify(M));e.showDialog("发送中...");var H=function(O){console.log("info:Method:Sreg003  出参： Result --> "+JSON.stringify(O));e.dismissDialog();if(O.code==TOKENLOST){var N=function(){User.login(f)};e.alert("亲，为了您的账户安全，请重新进行登录！",N);k("#con_yan_zheng_ma").text("发送短信");return}else{if(O.code!="000000"){e.alert("亲,验证码获取失败,"+O.content);k("#con_yan_zheng_ma").text("发送短信");return}}h=true;Toast.makeText("验证码已成功下发!",LENGTHLONG);D=setInterval(function(){k("#con_yan_zheng_ma").text(o+"秒");o--;if(o<0){k("#con_yan_zheng_ma").text("发送短信");clearInterval(D);o=30}},1000)};var J=function(N){e.dismissDialog();k("#con_yan_zheng_ma").text("发送短信")};e.sendPostRequest(URL+Method.MBinCrd002,M,H,J,"")}function B(G){if(G==BANK.bankInfo.yzbank.bankName){return 1}else{if(G==BANK.bankInfo.msbank.bankName||G==BANK.bankInfo.gfbank.bankName){return 2}else{return 0}}}function r(H,G){k("#selectBankNo").val(H);k("#startBankName").val(G);e.back()}});