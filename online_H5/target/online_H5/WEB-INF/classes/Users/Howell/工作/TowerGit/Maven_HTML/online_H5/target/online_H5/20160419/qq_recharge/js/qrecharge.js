define(["jquery","bestpay.ui","bestpay.lang","bestpay.http"],function(c,e,b,d){var f=null;function a(){f=this;this.noPwd=false;this.qqNum="";this.userInfo=JSON.parse(Bestpay.User.getSuccessLoginInfo());this.itemValue="1015";this.quanlitynum=50;this.qbInputNum="";this.buyMoney="";this._pName="10";this.userId="";this.ipPassword=null;this.orderPageJson={};this.successJson={};this.userPhone="";this.payType="0";this.checkBillCheck=false;this.rechargeData={};this.productId="0030001";this.selectBuyNumList=null;this.select_buy_num_fun=null;this.defferred=null;this.businessName="QQ充值"}a.prototype.initApp=function(){var g=this;config.TRADE_LIST_QUERY_TYPE=config.BUS_TYPE.BUS_TYPE_QQ;goTo(config.page.main,function(){g.qqNum=new e.InputText("QQnumber","number");document.getElementById("id_resource").onclick=function(){goTo(config.page.select_bank,function(){});var h=new e.dropDownBox("id_resource_list",this,{"Q币":"1015","QQ会员":"1013","QQ堂(紫钻)":"1012","QQ秀(红钻)":"1011","QQ游戏(蓝钻)":"1010","QQ空间(黄钻)":"1014"},function(j,i){h.hideDropDownBox();f.itemObjHtml=c(i).html();f.itemValue=j;c("#resource_show").html(f.itemObjHtml);g.loadSelectItem(j);g.qbInputNum.clearValue();back();setTimeout(function(){c("#select_buy_num").trigger("click")},200)},function(){h.hideDropDownBox();back()})};g.qbInputNum=new e.InputText("quantity","number",function(h){if(c("#id_buyNum_list").css("display")!="none"){g.flatFeeBox.hideDropDownBox();back()}},function(){document.getElementById("select_buy_num").onclick=g.select_buy_num_fun});g.userPhone=new e.InputText("userPhone","mobile");g.userPhone.clearValue();g.loadSelectItem("1015");g.btnInit()})};a.prototype.btnInit=function(){var g=this;g.select_buy_num_fun=function(){c("#id_buyNum_list").html("");goTo(config.page.select_buy_num,function(){});g.flatFeeBox=new e.dropDownBox("id_buyNum_list",this,g.selectBuyNumList,function(i,h){g.flatFeeBox.hideDropDownBox();if(i=="0"){c("#select_buy_num_list").hide();c("#quantity").show();document.getElementById("select_buy_num").onclick=null;back();return}c("#select_buy_num_list").show();c("#quantity").hide();f.itemObjHtml_=c(h).html();f.quanlitynum=i;c("#select_buy_num_val").html(f.itemObjHtml_);back()},function(){g.flatFeeBox.hideDropDownBox();back()})};document.getElementById("select_buy_num").onclick=g.select_buy_num_fun;document.getElementById("btn_next").onclick=function(){g.checkBillCheck=false;g.initClick()}};a.prototype.loadSelectItem=function(g){var h=this;if(g=="1015"){h.selectBuyNumList=config.selectItem.qb;c("#buyQbNum").show()}else{h.selectBuyNumList=config.selectItem.other;c("#buyQbNum").hide()}document.getElementById("select_buy_num").onclick=h.select_buy_num_fun;for(var i in h.selectBuyNumList){if(h.selectBuyNumList[i]=="50"||i=="1个月"){c("#select_buy_num_val").text(i);h.quanlitynum=h.selectBuyNumList[i];c("#select_buy_num_list").show();c("#quantity").hide();return}}};a.prototype.initClick=function(){var h=this;var i=h.qqNum.getToEmptyValue();var g=h.qbInputNum.getToEmptyValue();if(i.length<5){Bestpay.Toast.makeText("请输入正确的QQ号码",Bestpay.Toast.LENGTH_SHORT);return}if(g!=""&&parseInt(g)<5){Bestpay.Toast.makeText("充值Q币单笔不能小于5个",Bestpay.Toast.LENGTH_SHORT);return}if(g!=""&&parseInt(g)>500){Bestpay.Toast.makeText("充值Q币单笔不能超过500个",Bestpay.Toast.LENGTH_SHORT);return}this.mobile_val=h.userPhone.getToEmptyValue().replace(" ","");if(this.mobile_val!=null&&this.mobile_val!=""){if(this.mobile_val.length>11||this.mobile_val.length<11){Bestpay.Toast.makeText("请输入11位的顾客手机号码",Bestpay.Toast.LENGTH_SHORT);return}else{if(this.mobile_val.length!=11||!this.userPhone.getInputCheck()){Bestpay.Toast.makeText("您输入的手机号号码段不正确",Bestpay.Toast.LENGTH_SHORT);return}}}h.buyMoney=h.qbInputNum.getToEmptyValue()!=null&&h.qbInputNum.getToEmptyValue()!=""?h.qbInputNum.getToEmptyValue():h.quanlitynum;h.itJudgeLocalStorage=new e.JudgeLocalStorage();h.itJudgeLocalStorage.checkOrder(i,h.buyMoney*1,d.getCurrentTime(),function(){h.queryStart();h.SDiscQuery();h.defferred.done(h.goPayAnimation)},h.businessName)};a.prototype.SDiscQuery=function(){var g=this;d.callCPSService({service:config.CPS.SDISCQUERY,params:g.SDiscQueryParams(),showLoading:false,success:g.SDiscQuerySuccessCallback})};a.prototype.SDiscQueryParams=function(){var g=this;var h={rechAmount:b.yuan2fen(g.buyMoney),pecProduct:config.QQproductCode[g.itemValue]};h=d.setCPSCommonParams(h);console.log("折价查询SDISCQUERY 入参==");return h};a.prototype.SDiscQuerySuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){Bestpay.Dialog.showAlertDialog("提醒",g.content,"确定",g.code);return}console.log("折价查询SDISCQUERY 出参=="+JSON.stringify(g));f.orderPageJson={};f.orderPageJson.rewardType="zhejia";f.orderPageJson.reward=b.fen2yuan(g.discAmount);f.orderPageJson.contact=f.qqNum.getToEmptyValue();f.orderPageJson.cardAmount=(f.buyMoney*1).toFixed(2);f.orderPageJson.supplyCode=g.supplyCode;f.orderPageJson.buyTypeName=f.itemValue=="1015"?"充值数据":"充值时长";f.orderPageJson.buyProductName=config.productName[f.itemValue];f.orderPageJson.buyProductCode=config.QQproductCode[f.itemValue];f.orderPageJson.buyNum=f.itemValue=="1015"?(f.buyMoney*1)+"Q币":parseInt(f.buyMoney*1).toString().replace("0","")+"个月";f.callQuickTradingQuery()};a.prototype.callQuickTradingQuery=function(){var g=this;d.callCPSService({service:config.CPS.QUICK_TRADING_QUERY,params:g.quickTradingQueryParams(),showLoading:false,success:g.quickTradingQuerySuccessCallback})};a.prototype.quickTradingQueryParams=function(){var g=this;var h={};h=d.setCPSCommonParams(h);return h};a.prototype.quickTradingQuerySuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){if(g.code=="006781"){Bestpay.Dialog.showAlertDialog(config.TITLE.dialog_title,"账户异常，请确认后再试","确定",g.code);return}Bestpay.Dialog.showAlertDialog(config.TITLE.dialog_title,g.content,"确定",g.code);return}f.quickTranInfo={perAmount:g.perAmount,allamount:g.allamount,alltransaction:g.alltransaction};f.handleIsneedpassword()};a.prototype.handleIsneedpassword=function(){var h=this.quickTranInfo;var g=b.yuan2fen(this.buyMoney);console.log("amount : "+g);console.log("quickTranInfo : "+JSON.stringify(h));if(g*1<=1*h.perAmount&&(g*1+1*h.alltransaction)<=1*h.allamount){f.noPwd=false}else{f.noPwd=true}console.log("rechargeSelf.userInfo.authenStatus=="+f.userInfo.authenStatus);if(f.userInfo.authenStatus=="A02"){console.log("rechargeSelf.userInfo.hadEpt  "+f.userInfo.hadEpt);if(f.userInfo.hadEpt==1){f.getFinancialProducts()}else{f.fundAccountBalanceInquiry()}}else{f.fundAccountBalanceInquiry()}};a.prototype.getFinancialProducts=function(){var g=this;d.callCPSService({service:config.CPS.FINANCIAL_PRODUCTS,params:g.getFinancialProductsParams(),showLoading:false,success:g.getFinancialProductsSuccessCallback})};a.prototype.getFinancialProductsParams=function(){var g=this;var h={};h=d.setCPSCommonParams(h);return h};a.prototype.getFinancialProductsSuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){if(g.code==="018888"){f.fundAccountBalanceInquiry();return}else{Bestpay.Dialog.showAlertDialog("提醒",g.content,"确定",g.code);return}}var j=g.datas;for(var h=0;h<j.length;h++){f.orderPageJson.productId=j[h]["productId"];f.orderPageJson.userId=j[h]["userId"];f.orderPageJson.tyb_amount=b.fen2yuan(j[h]["balance"])}f.fundAccountBalanceInquiry()};a.prototype.fundAccountBalanceInquiry=function(){var g=this;d.callCPSService({service:config.CPS.CCOUNT_BALANCE_QUERY,params:g.fundAccountBalanceInquiryParams(),showLoading:false,success:g.fundAccountBalanceInquirySuccessCallback})};a.prototype.fundAccountBalanceInquiryParams=function(){var g=this;var h={bankMode:g.userInfo.bankMode};h=d.setCPSCommonParams(h);return h};a.prototype.fundAccountBalanceInquirySuccessCallback=function(t){if(t.code!==config.RES.SUCCESS){Bestpay.Dialog.showAlertDialog("提醒",t.content,"确定",t.code);return}console.log("资金账户余额查询 SAcc003出参======="+JSON.stringify(t));var r=t.dayLimit;var h=t.dayTotal;var k=r*1-h*1;var g=t.monthLimit;var n=t.monthTotal;var m=g*1-n*1;var p=t.motherBoard;var o=t.accountItems;for(var l=0;l<o.length;l++){var q=o[l]["acctType"];if(q!=null||q!="null"||q!="undefined"||q!=""){if("0007"==q){var j=o[l].activeBalance;f.orderPageJson.jfy_amount=b.fen2yuan(j);break}}}if(config.CARD_TYPE.BANK_MODE_FUND_POOL_MEMBER_CARD===f.userInfo.bankMode){var s="";if(r==="0"){s=p}else{if(p>k){s=k}else{s=p}}if(g==="0"){s=p}else{if(p>m){s=m}else{s=p}}f.orderPageJson.jfy_amount=b.fen2yuan(s);console.log("子卡＝＝"+f.orderPageJson.jfy_amount)}f.queryEnd()};a.prototype.setOrderDisplay=function(j){var h=this;var g=document.getElementById("code009002");if(j==="overtime"){g.style.display="block";f.successJson.acctCode=h.orderPageJson.contact;f.successJson.txnAmount=(h.buyMoney*1).toFixed(2);var i=new e.Template();i.template_OneToOne("id_success_item_overtime",h.successJson);goTo(config.page.float_dia);dismissDialog();console.log("self.payType=="+h.payType);if(h.payType=="1"){App.updateTybRereshFlag()}config.isBack=function(){if(window.jqXHR.readyState>2){Bestpay.App.exitApp()}}}if(j==="normal"){g.style.display="none"}};a.prototype.gotoOrder=function(g){d.getRandomServices(function(h){var i=h;if(h.code===config.RES.SUCCESS){f.random=h.randNum}f.rechargeResp(g)},false)};a.prototype.rechargeResp=function(h){var g=this;d.callCPSService({service:config.CPS.TTQQ003,params:g.rechargeParams(h),showLoading:true,success:g.rechargeSuccessCallback})};a.prototype.rechargeParams=function(j){var g=this;var h="";if(j!=null&&j!=""){h=j}g.orderPageJson.buyNum=parseInt(g.orderPageJson.buyNum);var i={phone:(g.mobile_val.replace(/\s/g,"")),orderSeq:d.getOrderSeq(),rechQuantity:g.orderPageJson.buyNum,rechAmount:(g.buyMoney*100).toFixed(0),productCode:g.orderPageJson.buyProductCode,acctCode:g.orderPageJson.contact,tradeTime:d.getOrderSeq(),supplyCode:g.orderPageJson.supplyCode};if(f.userInfo.hadEpt.toString()=="1"){i.costWay=g.paymentPlugin.getPayType();i.productId=g.productId;i.userId=f.orderPageJson.userId}console.log("充值接口出参== "+JSON.stringify(i));if(f.noPwd==true){i.password=Bestpay.Security.encryptPassword(g.userInfo.staffCode,h,g.random)}i=d.setCPSCommonParams(i);return i};a.prototype.rechargeSuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){if(g.code=="009002"||g.code=="006751"){f.paymentPlugin.setOrderDisplay("overtime");goTo(config.page.float_dia);return}if(g.code===config.RES.MONEY_NOT_ENOUGH){Bestpay.Dialog.showAlertDialog(config.TITLE.no_repeat,config.RES.MONEY_NOT_ENOUGH_MSG,"确定",g.code,function(h){back();f.itJudgeLocalStorage.putLocalValue("","","","")});return}else{if(g.code==config.RES.PASSWORD_ERROR_LOCKED_002136){Bestpay.Dialog.showAlertDialog(config.TITLE.no_repeat,g.content,"确定",g.code,function(){App.exitCompleteApp();f.itJudgeLocalStorage.putLocalValue("","","","")})}else{Bestpay.Dialog.showAlertDialog(config.TITLE.no_repeat,g.content,"确定",g.code,function(){back();f.itJudgeLocalStorage.putLocalValue("","","","")})}}return}f.itJudgeLocalStorage.putLocalValue("","","","");if(f.mobile_val.length>0){d.sendSmsCertificate(g.transSeq,f.mobile_val,"")}f.paymentPlugin.setOrderDisplay("success");goTo(config.page.float_dia);config.isBack=function(){if(window.jqXHR.readyState>2){Bestpay.App.exitApp()}}};a.prototype.queryStart=function(){var g=this;g.defferred=c.Deferred();showDialog()};a.prototype.queryEnd=function(){var g=this;console.log(JSON.stringify(g.orderPageJson));var h={businessName:g.businessName,accountName:"QQ充值",accouontValue:g.orderPageJson.contact,rechargeMoney:g.buyMoney,rewardType:g.orderPageJson.rewardType,rewardMoney:g.orderPageJson.reward,jfyBalance:g.orderPageJson.jfy_amount,tybBalance:g.orderPageJson.tyb_amount,enablePassword:g.noPwd,userInfo:g.userInfo,callback:g.gotoOrder};console.log("pluginParam = "+JSON.stringify(h));g.paymentPlugin=new e.paymentPlugin(h);dismissDialog();goTo(config.page.comfirm,function(){});g.defferred.resolve()};a.prototype.goPayAnimation=function(){console.log("done=========================");c("#order_comfirm").removeClass("backPayAnimation").addClass("goPayAnimation")};return a});