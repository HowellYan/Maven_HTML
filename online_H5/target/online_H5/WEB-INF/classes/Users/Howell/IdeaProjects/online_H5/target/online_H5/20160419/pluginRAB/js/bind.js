define(["utils","jquery"],function(y,E){var z=User.getProduct();var a=User.getSuccessLoginInfo();if(androidOrIos=="ios"){a=User.getSuccessLoginInfo()}else{a=JSON.parse(User.getSuccessLoginInfo())}var q=a.staffCode;var h=a.custCode;var w=a.prtnCode;var x=y.getUtilParams();var t=x.clientVersion;var r=x.systemType;console.log("111clientVersion  = "+t);console.log("111systemType = "+r);t=t.replace(/\./g,"")*1;r=r.toLowerCase();console.log("111clientVersion  = "+t);console.log("111systemType = "+r);var B=false;if(a.bindCard=="1"){Toast.makeText("该账户已经绑卡",1000);App.exitApp();return}var d="1";var n=new Array();E(function(){y.showDialog("请稍等..");C();console.log("click init");f();setTimeout(function(){y.dismissDialog()},2000);b()});function b(){E(":input").each(function(){E(this).focus(function(){E(this.parentNode.parentNode.parentNode).addClass("selectInputDiv");E(this.parentNode.parentNode.parentNode).removeClass("noselectInputDiv")});E(this).blur(function(){E(this.parentNode.parentNode.parentNode).removeClass("selectInputDiv");E(this.parentNode.parentNode.parentNode).addClass("noselectInputDiv")})});E("#quickBankPrePhone").on("input",function(){var G=E(this).val();E(this).val(E(this).val().replace(/[^0-9]+/,""));if(G.length>0){E("#id_clearPhone").show();E("#id_clearPhone").click(function(){E(this).hide();E("#quickBankPrePhone").val("")})}else{E("#id_clearPhone").hide()}});E("#bangBankPrePhone").on("input",function(){var G=E(this).val();E(this).val(E(this).val().replace(/[^0-9]+/,""));if(G.length>0){E("#id_clearbangBankPrePhone").show();E("#id_clearbangBankPrePhone").click(function(){E(this).hide();E("#bangBankPrePhone").val("")})}else{E("#id_clearbangBankPrePhone").hide()}});E("#msgVerifyCode").on("input",function(){var G=E(this).val();E(this).val(E(this).val().replace(/[^0-9]+/,""));if(G.length>0){E("#id_verifyCodePhone").show();E("#id_verifyCodePhone").click(function(){E(this).hide();E("#msgVerifyCode").val("")})}else{E("#id_verifyCodePhone").hide()}});E("#openBankBranchInfo").on("input",function(){var G=E(this).val();if(G.length>0){E("#id_clearopenBankBranchInfo").show();E("#id_clearopenBankBranchInfo").click(function(){E(this).hide();E("#openBankBranchInfo").val("")})}else{E("#id_clearopenBankBranchInfo").hide()}});E("#startBankCode").blur(function(){var G=E(this).val();if(!isNaN(G.replace(/\s/g,""))){E(this).val(G.replace(/\s/g,"").replace(/(\d{4})(?=\d)/g,"$1 "))}});E("#startBankCode").focus(function(){var G=E(this).val();E(this).val(G.replace(/\s/g,""))})}function f(){var G=0;E("#selectBankDiv").width((E("#id_open_outDiv").width()+2)+"px");document.getElementById("startBankCode").addEventListener("input",function(){console.log("------------------"+E("#startBankCode").val());var I=E("#startBankCode").val().substring(E("#startBankCode").val().length-1,E("#startBankCode").val().length);var H=E("#startBankCode").val();H=H.replace(/\s+/g,"");G=E("#startBankCode").val().length;if(/^[a-zA-Z]+$/.test(H)){E("#startBankCode").val("");G=0;return}if(/[\u4E00-\u9FA5]/g.test(H)){E("#startBankCode").val("");G=0;return}if(/[^0-9]+/.test(I)||G>19){E("#startBankCode").val(E("#startBankCode").val().substring(0,E("#startBankCode").val().length-1));G-=1;return}if(H.length>0){E(this).next("img").css("display","block");E(this).next("img").click(function(){E("#startBankCode").val("");E(this).css("display","none")})}else{E(this).next("img").css("display","none")}},false);E("#showBankNoHelp").click(function(){y.alert("银行预留手机号是办理该银行卡时所填写的手机号码，没有预留、忘记预留手机号、手机已停用，请联系银行客服",function(){},"知道了")});E("#showBankNoHelp2").click(function(){y.alert("银行预留手机号是办理该银行卡时所填写的手机号码，没有预留、忘记预留手机号、手机已停用，请联系银行客服",function(){},"知道了")});document.getElementById("showBankNoPicParent").onclick=function(){console.log("TalkingData = ");if((r==="ios"&&t>=403)||(r==="android"&&t>=406)){TalkingData.onEventWithLabel("添加银行卡","OCR识别银行卡");Scanner.bankOCR(function(J){console.log("bankOCR resultData:"+J);E("#startBankCode").val(JSON.stringify(J).replace(/\"/g,""));if(E("#startBankCode").val().toString().trim()!=""){E("#bankCodeImg").show()}else{E("#bankCodeImg").hide()}E("#bottomText").show();var K=E("#startBankCode").val().replace(/\s+/g,"");var I=E("#startBankName").val();var H={};H.code=E("#selectBankNo").val().trim();l=y.getSQLiteData("CardList","queryRelevant",H);console.log("BankNoBinList --> "+JSON.stringify(l));if(!D(l,K,E("#selectBankNo").val())){return}})}};E("#selectBank_background").click(function(){y.back()});E("#bankCardPicDiv").click(function(){y.back()});E("#authareasShow").click(function(){console.log("选择地区！！");p="openBankPosition";F("authprovice","getProvinceData","provice",null,true)});E("[name=confirmFuWu]").click(function(){var H=E(this).children("span").html();console.log("-------------"+H);if(H=="0"){E(this).css("background","url(images/check_ok.png)");E(this).css("background-size","contain");E(this).children("span").html("1");console.log("ok")}else{E(this).css("background","url(images/check_no.png)");E(this).css("background-size","contain");E(this).children("span").html("0");console.log("on")}})}function C(){var H=y.getUtilParams();H.channelCode="20";H.staffCode=q;H.custCode=h;H.bisChannel=bisChannel;H.merId=w;H.keep=y.getKeep();var I=Security.getSign(H);H.sign=I;H.signVer="2";console.log("#########获取支持绑卡的银行列表入参="+JSON.stringify(H));y.showDialog("加载中..");var G=function(K){console.log("#########获取支持绑卡的银行列出参"+JSON.stringify(K));y.dismissDialog();if(K.code=="012109"){y.alert("亲，为了您的账户安全，请先进行认证或等候认证完成！");return}else{if(K.code==TOKENLOST){var M=function(){User.login(z)};y.alert("亲，为了您的账户安全，请重新进行登录！",M);return}else{if(K.code!="000000"){y.alert(K.content+" ("+K.code+")");return}}}var L=K.bankCardList.length;for(var N=0;N<L;N++){var J=K.bankCardList[N].stat;if(J===d){n[N]={bankCode:K.bankCardList[N].bankCode,bankName:K.bankCardList[N].bankName}}}A()};y.sendPostRequest(URL+Method.SCbk002,H,G,null)}function A(){var J=document.getElementById("selectBankDiv");console.log("supportBankList"+JSON.stringify(n));for(var I=0;I<n.length;I++){var H=document.createElement("div");H.className="containterborderall btop-none";J.appendChild(H);var G=document.createElement("div");G.className="ub line";G.setAttribute("bankCode",n[I].bankCode);G.setAttribute("bankName",n[I].bankName);G.innerHTML=n[I].bankName;G.onclick=function(){E("#startBankCode").val("");i(E(this).attr("bankCode"),E(this).attr("bankName"))};H.appendChild(G)}}var v;var o={};var e=null;function F(M,G,I,H,K){var L="";console.log(K);if(!K){E("#authdistrict").html(L);v=""}var J=DB_Data.getActionCode(G,JSON.stringify(H));console.log("地区出参 --> "+JSON.stringify(J));for(var N=0;N<J.length;N++){L+="<div style = 'text-align:center;width:100%;border:1px solid #e4d9d9 ; margin:0px;' class='proviceCity "+I+"'>"+J[N].name+"<span style='display:none;'>"+J[N].code+"</span></div>"}E("#"+M).html(L);if(K&&e!==null){E("#"+M).children().eq(e).css({background:"#F0801E",color:"#FFF"})}E("."+I).click(function(){if(M!="authcity"){F("authcity","getCityData()","city",{code:E(this).children("span").text()},false)}var O=E(this).text().replace(E(this).children("span").text(),"");if(M=="authprovice"){o.proviceName=O;document.title=O;App.setTitle(O)}else{o.cityName=O;document.title=o.proviceName+O;App.setTitle(o.proviceName+O)}if(M=="authcity"){v=E(this).children("span").text()}if(K){e=E(this).index()}E(this).css({background:"#F0801E",color:"#FFF"});E(this).siblings().css({background:"#ECECEC",color:"#000"});console.log("地区选择"+v+"  || "+o.proviceName+"-"+o.cityName)});if(M=="authprovice"){y.toNextPage("authselectdizPage")}}var p;E("#confirmCity").click(function(){if(v==null||v==""||v==undefined){Toast.makeText("请选择完整的地区！",LENGTHLONG);return}E("#"+p).val(o.proviceName+"-"+o.cityName);y.back()});var l=null;E("#bindCardPageNext").click(function(){if(!y.notEmptyVail("startBankName",ERROR.bankNameEmptyError,null)){return}if(!y.bankNoVail("startBankCode")){return}var K=E("#startBankCode").val().replace(/\s+/g,"");var J=E("#startBankName").val();var H={};H.code=E("#selectBankNo").val().trim();l=y.getSQLiteData("CardList","queryRelevant",H);console.log("BankNoBinList --> "+JSON.stringify(l));if(!D(l,K,E("#selectBankNo").val())){return}var G={staffCode:q,channelCode:"20",bisChannel:bisChannel,custCode:h,merId:w,tmnNum:"440106003094",keep:y.getKeep()};y.getDeviceInfo(G);var I=Security.getSign(G);G.sign=I;G.signVer="2";console.log("infoInit() 入参："+JSON.stringify((G)));y.showDialog("加载中..");var L=function(N){console.log("info:Method:Sreg003  出参： Result --> "+JSON.stringify(N));if(N.code==TOKENLOST){var M=function(){User.login(z)};y.alert("⊙_⊙,为了您的账户安全，请您重新登录。",M);y.dismissMDialog("ch_dialog");return}else{if(N.code!="000000"){y.alert("⊙_⊙网络不给力哦，请检查后再试哈");y.dismissMDialog("ch_dialog");return}}y.dismissDialog();console.log("------------------------prinType:+"+a.prinType);if(a.prinType=="PT901"){m(N.staffName,N.certNbr,J,K);return}var M=function(){y.back()};var O="";if(androidOrIos=="ios"){O=User.getSuccessLoginInfo()}else{O=JSON.parse(User.getSuccessLoginInfo())}productType=O.productType;console.log("authenStatus================="+N.authenStatus);console.log("productType================="+productType);if(N.authenStatus=="A01"&&productType!="3"){y.alert("⊙_⊙无法绑卡,您还未认证！请先进行认证！",M)}else{if(N.authenStatus=="A00"){}else{if(N.authenStatus=="A99"&&productType!="3"){y.alert("⊙_⊙无法绑卡,认证失败！请尝试再次认证或联系客服！",M)}}}m(N.staffName,N.certNbr,J,K)};y.sendPostRequest(URL+Method.SAcc001,G,L,null)});var u=[];var s=[];function D(P,K,H){console.log("---------------------code:"+H);u.length=0;s.length=0;var I="";if(K.length<=10){I=K}else{I=K.substr(0,10)}var O=P;var J=[];for(var M=3;M<=I.length;M++){s.length=0;J.length=0;for(var L=0;L<O.length;L++){if(I.indexOf(O[L].CARD_BIN.toString().substr(0,M))==0){s.push(O[L]);console.log("777(_bin_xs[j].CARD_BIN =="+(O[L].CARD_BIN));console.log("777 _bin_card"+I.toString().substr(0,M));if(O[L].CARD_BIN==I.toString().substr(0,M)){J.push(O[L])}console.log("777 BANK_NAME =="+O[L].BANK_NAME);E("#startBankName").val(O[L].BANK_NAME);H=O[L].BANK_CODE}}O=s.concat();console.log("sunte consolog"+J.length);if(J.length>0){u.length=0;u=J.concat()}}if(s.length==0&&u.length==0){E("#startBankName").val("");if(H==""){Toast.makeText("",LENGTHLONG)}else{Toast.makeText("您输入的银行帐号与开户银行不匹配",LENGTHLONG)}BankIsRight=false;return false}else{if(u.length==1){if(H==""){E("#selectBankNo").val(u[0].BANK_CODE);console.log("999 = "+E("#selectBankNo").val());H=u[0].BANK_CODE}if(H!==u[0].BANK_CODE){BankIsRight=false;Toast.makeText("您的卡号输入有误",LENGTHLONG);return false}if(K.length==u[0].card_bit){E("#selectBankNo").val(u[0].BANK_CODE);console.log("999 = "+E("#selectBankNo").val());H=u[0].BANK_CODE;BankIsRight=true;return true}else{BankIsRight=false;Toast.makeText("您的卡号输入有误",LENGTHLONG);return false}}else{if(u.length>1){var N=false;for(var M=0;M<u.length;M++){var G=u[M].CARD_BIN;var Q=u[M].card_bit;if(K.substr(0,G.length)==G&&K.length==Q){if(H!==u[M].BANK_CODE){BankIsRight=false;Toast.makeText("您的卡号输入有误",LENGTHLONG);return false}BankIsRight=true;N=true;break}}if(!N){BankIsRight=false;Toast.makeText("您的卡号输入有误",LENGTHLONG)}return N}}}}function m(K,J,I,G){$_id("yzPayMoney").style.display="none";if(g(I)=="0"||g(I)==1){$_id("quickConfirmBindCardButton").innerHTML="确定";if(g(I)==1){Dialog.showAlertTwoBtnDialog("提醒",'"亲，请先确认是否已开通银联在线无卡支付功能。',"确定","取消","",function(L){console.log("code");if(L=="1"){H()}});$_id("yzPayMoney").style.display="block"}else{H()}function H(){E("#quickBankName").html(E("#startBankName").val());E("#quickBankAccount").html(G);E("#quickCardholderName").html(K);E("#quickIdentityCardNum").html(J);E("#id_clearPhone").click();E("#id_verifyCodePhone").click();y.toNextPage("quickBindCardPage");clearInterval(j);c=30;E("#con_yan_zheng_ma").text("发送短信");B=false}}else{E("#bangBankName").val(I);E("#bangBankAccount").val(G);E("#bangCardholderName").val(K);E("#bangIdentityCardNum").val(J);E("#openBankPosition").val("");E("#openBankBranchInfo").val("");E("#bangBankPrePhone").val("");E("#id_clearbangBankPrePhone").hide();E("#id_clearopenBankBranchInfo").hide();y.toNextPage("bangFuTongBindCardPage");$_id("quickConfirmBindCardButton").innerHTML="下一步"}}E("#quickConfirmBindCardButton").click(function(){if(!y.phoneNumVail("quickBankPrePhone",ERROR.openBankPhoneEmptyError)){return}if(!B){Toast.makeText("请先下发短信验证码！",LENGTHLONG);return}if(!y.notEmptyVail("msgVerifyCode","请输入短信验证码！")){return}if(E("#quickConfirmFuWu").children("span").html()=="0"){Toast.makeText("请先阅读并同意服务协议！",LENGTHLONG);return}var K=E("#msgVerifyCode").val();var L=$_id("quickBankPrePhone").value;var M=E("#selectBankNo").val();var G=E("#startBankCode").val();G=G.replace(/\s+/g,"");var I={staffCode:q,operType:"1",veriCode:K,custCode:h,bankAcc:G,bankAddr:"",bankCode:M,phoneNum:L,channelCode:"20",merId:w,tmnNum:"440106003094",bisChannel:bisChannel,keep:y.getKeep()};y.getDeviceInfo(I);var J=Security.getSign(I);I.sign=J;I.signVer="2";console.log("快捷绑卡 入参 --> "+JSON.stringify(I));y.showDialog("正在提交您的信息..");var H=function(P){console.log("快捷绑卡 出参 --> "+JSON.stringify(P));y.dismissDialog();if(P.code=="012109"){y.alert("亲，为了您的账户安全，请先进行认证或等候认证完成！");return}else{if(P.code==TOKENLOST){var O=function(){User.login(z)};y.alert("亲，为了您的账户安全，请重新进行登录！",O);return}else{if(P.code!="000000"){y.alert(P.content+" ("+P.code+")");return}}}var N=function(){App.exitAppFromBandCard("1")};var Q=function(){App.exitAppFromBandCard("2");return};console.log("------------bankAcc------- "+G.substring(G.length-4,G.length));App.updateUserInfo("1");y.toNextPage("bandKaSuccess")};y.sendPostRequest(URL+Method.MBinCrd002,I,H,null)});document.getElementById("bangKaRecharge").onclick=function(){App.exitAppFromBandCard("1")};E("#bangNextPayBtn").click(function(){if(!y.notEmptyVail("openBankBranchInfo",ERROR.openBankZhiHangInfoEmptyError)){return}if(!y.phoneNumVail("bangBankPrePhone",ERROR.bankReservePhoneEmptyError)){return}if(v==null||v==""||v==undefined){Toast.makeText("请选择完整的地区！",LENGTHLONG);return}if(E("#bangConfirmFuWu").children("span").text()=="0"){Toast.makeText("请先阅读并同意服务协议！",LENGTHLONG);return}var J=E("#openBankBranchInfo").val();var M=E("#bangBankPrePhone").val();var M=E("#bangBankPrePhone").val();var L=v;var O=y.getKeep().substring(10,16);var G=E("#selectBankNo").val();var N=E("#startBankCode").val();N=N.replace(/\s+/g,"");var I=y.getUtilParams();I.verifyType="000";I.orderNo=y.getOrderSeq();I.staffCode=q;I.custCode=h;I.areaCode=L;I.phone=M;I.openBank=J;I.bankCode=G;I.bankAcct=N;I.channelCode="20";I.bisChannel=bisChannel;I.keep=y.getKeep();y.getDeviceInfo(I);var H=Security.getSign(I);I.sign=H;I.signVer="2";console.log("帮付通绑卡验证 入参 -->:"+JSON.stringify(I));y.showDialog("正在跳转，请稍等..");var K=function(U){console.log("帮付通绑卡验证 出参 -->:"+JSON.stringify(U));y.dismissDialog();if(U.code=="012109"){y.alert("亲，为了您的账户安全，请先进行认证或等候认证完成！");return}else{if(U.code==TOKENLOST){var T=function(){User.login(z)};y.alert("亲，为了您的账户安全，请重新进行登录！",T);return}else{if(U.code!="000000"){y.alert(U.content+" ("+U.code+")");return}}}var P=U.forwardUrl;var S=U.orderNo;var Q=N;var R=function(){};App.startBangfutongActivity(P,S,Q)};y.sendPostRequest(URL+Method.MBinCrd001,I,K,null)});E("[name = paymentServiceAgreement]").click(function(){var G=E("#serviceProtocalPage").setTemplateURL("tpl/WithholdingAgreement_v1.0.html");G.processTemplate({});y.toNextPage("serviceProtocalPage")});E("#showSupportBankListButton").click(function(){y.toNextPage("supportBankListPage")});E("#selectStartBankName").click(function(){y.toNextPage("selectBankDiv");App.setTitle("请选择开户银行")});var c=30;E("#con_yan_zheng_ma").click(function(){k()});var j;function k(){if(!y.phoneNumVail("quickBankPrePhone",ERROR.openBankPhoneEmptyError)){return}if(c!=30||E("#con_yan_zheng_ma").text()=="获取中..."){Toast.makeText("请稍等...",LENGTHLONG);return}E("#con_yan_zheng_ma").text("获取中...");clearInterval(j);var L=$_id("quickBankPrePhone").value;var G=E("#selectBankNo").val();var H=E("#startBankCode").val();H=H.replace(/\s+/g,"");console.log("------------bankAcc------- "+H.substring(H.length-4,H.length));console.log("999 = "+G);console.log("999 = "+E("#selectBankNo").val());var I={staffCode:q,operType:"0",bankCode:E("#selectBankNo").val(),custCode:h,bankAcc:H,phoneNum:L,channelCode:"20",merId:w,keep:y.getKeep(),bisChannel:bisChannel,tmnNum:"440106003094"};y.getDeviceInfo(I);var J=Security.getSign(I);I.sign=J;I.signVer="2";console.log("#########绑卡获取短信验证码入参："+JSON.stringify(I));y.showDialog("发送中...");var K=function(O){console.log("info:Method:Sreg003  出参： Result --> "+JSON.stringify(O));y.dismissDialog();if(O.code==TOKENLOST){var N=function(){User.login(z)};y.alert("亲，为了您的账户安全，请重新进行登录！",N);E("#con_yan_zheng_ma").text("发送短信");return}else{if(O.code!="000000"){y.alert("亲,验证码获取失败,"+O.content);E("#con_yan_zheng_ma").text("发送短信");return}}B=true;Toast.makeText("验证码已成功下发!",LENGTHLONG);j=setInterval(function(){E("#con_yan_zheng_ma").text(c+"秒");c--;if(c<0){E("#con_yan_zheng_ma").text("发送短信");clearInterval(j);c=30}},1000)};var M=function(N){y.dismissDialog();E("#con_yan_zheng_ma").text("发送短信")};y.sendPostRequest(URL+Method.MBinCrd002,I,K,M,"")}function g(G){if(G==BANK.bankInfo.yzbank.bankName){return 1}else{if(G==BANK.bankInfo.msbank.bankName||G==BANK.bankInfo.gfbank.bankName){return 2}else{return 0}}}function i(H,G){E("#selectBankNo").val(H);E("#startBankName").val(G);y.back()}});