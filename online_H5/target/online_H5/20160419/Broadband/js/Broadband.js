define(["jquery","bestpay.ui","bestpay.lang","bestpay.http"],function(d,f,c,e){var b=null;function a(){b=this;this.userInfo=JSON.parse(Bestpay.User.getSuccessLoginInfo());this.selectType=null;this.random=null;this.BROADBANDNUM="03010100";this.pecProductCode="00000007";this.phone_area=null;this.phone_number=null;this.phone_amount=null;this.isReload=true;this.itMobile=null;this.ipPassword=null;this.orderPageJson={};this.successJson={};this.payType="0";this.checkBillCheck=false;this.BroadbandData={};this.productId="0030001";this.paymentPlugin=null;this.businessName="电信固话"}a.prototype.initApp=function(){config.TRADE_LIST_QUERY_TYPE=config.BUS_TYPE.BUS_TYPE_FIXEDPHONEBROADBAND;var g=this;goTo(config.page.main,function(){console.log("--------------start--------------");var h=function(i){if(g.BROADBANDNUM!=i){g.hideMagDiv();g.phone_area.clearValue();g.phone_number.clearValue()}g.BROADBANDNUM=i;if(i=="03010100"){d("#phone_number").attr("placeholder","固话号码");d("#phone_number").attr("type","tel");d(".fixed-line").show();g.businessName="电信固话"}else{if(i=="03010200"){d("#phone_number").attr("placeholder","宽带号码");d("#phone_number").attr("type","text");d(".fixed-line").hide();g.businessName="电信宽带"}}};g.selectType=new f.BlockRadioGroup("brg_amount","item03010100",h);g.phone_area=new f.InputText("phone_area","number",function(){g.hideMagDiv()},function(){g.hideMagDiv()});g.phone_number=new f.InputText("phone_number",null,function(i){d("#id_confirm_amount").hide();d("#id_confirm_name").hide();if(g.BROADBANDNUM=="03010100"){g.phone_number.setValue(i.replace(/[^0-9]+/,""));i=g.phone_number.getToEmptyValue();if(i.length==0){d(g.phone_number.btnClear).hide()}}},function(){d("#id_confirm_amount").hide();d("#id_confirm_name").hide()});g.phone_number.blur(function(){setTimeout(function(){if(g.validaForm()==false){return}if(g.isReload==true){}g.extractsClientName()},11)});g.phone_area.blur(function(){d("#id_confirm_amount").hide();setTimeout(function(){if(g.phone_number_val!=null&&g.phone_number_val.length>=5){g.phone_area_val=g.phone_area.getToEmptyValue();if(g.phone_area_val==null||g.phone_area_val.length==0){Bestpay.Toast.makeText("请输入区号",Bestpay.Toast.LENGTH_SHORT);return false}else{if(g.phone_area_val.length<3||g.phone_area_val.length>5){Bestpay.Toast.makeText("请输入正确的区号",Bestpay.Toast.LENGTH_SHORT);return false}}if(g.isReload==true){g.extractsClientName()}}config.isOpen=true;g.extractsTheArea()},11)});g.phone_amount=new f.InputText("phone_amount","number");g.itMobile=new f.InputText("mobile","mobile");g.btnInit()})};a.prototype.btnInit=function(){var g=this;document.getElementById("btn_next").onclick=function(){g.checkBillCheck=false;g.validation()}};a.prototype.extractsTheArea=function(){var g=this;e.callCPSService({service:config.CPS.ExtractsTheArea,params:g.extractsTheAreaParams(),showLoading:false,success:g.extractsTheAreaSuccessCallback})};a.prototype.extractsTheAreaParams=function(){var g=this;var h={};h.areaCode=g.phone_area.getToEmptyValue();h=e.setCPSCommonParams(h);return h};a.prototype.extractsTheAreaSuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){Bestpay.Toast.makeText(g.content+"("+g.code+")",Bestpay.Toast.LENGTH_SHORT);return}if(g.provinceName==null||g.cityName==null||g.provinceName=="null"||g.cityName=="null"){return}b.orderPageJson.content=g.provinceName+"-"+g.cityName;b.orderPageJson.provinceCode=g.provinceCode;var h=new f.Template();h.template_OneToOne("id_msg",b.orderPageJson);b.showMagDiv();if(b.orderPageJson.amount_val==""||b.orderPageJson.amount_val==null){d("#id_confirm_amount").hide();d("#id_confirm_name").hide()}};a.prototype.extractsClientName=function(){var g=this;e.callCPSService({service:config.CPS.ExtractsClientName,params:g.extractsClientNameParams(),showLoading:false,success:g.extractsClientNameSuccessCallback})};a.prototype.extractsClientNameParams=function(){var g=this;var h={};h.telNum=g.phone_area.getToEmptyValue()+""+g.phone_number.getToEmptyValue();if(g.BROADBANDNUM=="03010100"){h.type="3"}else{if(g.BROADBANDNUM=="03010200"){h.type="2"}}h=e.setCPSCommonParams(h);return h};a.prototype.extractsClientNameSuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){Bestpay.Toast.makeText(g.content+"("+g.code+")",Bestpay.Toast.LENGTH_SHORT);return}if(g.custName==null||g.balance==null||g.custName=="null"||g.balance=="null"){return}b.orderPageJson.custName_val=g.custName;b.orderPageJson.amount_val=g.balance;var h=new f.Template();h.template_OneToOne("id_msg",b.orderPageJson);b.showMagDiv();d("#id_confirm_amount").show();d("#id_confirm_name").show();if(b.orderPageJson.provinceCode!=null&&b.orderPageJson.provinceCode!="510000"){d("#id_confirm_amount").hide();d("#id_confirm_name").hide()}};a.prototype.callQuickTradingQuery=function(){var g=this;e.callCPSService({service:config.CPS.QUICK_TRADING_QUERY,params:g.quickTradingQueryParams(),showLoading:false,success:g.quickTradingQuerySuccessCallback})};a.prototype.quickTradingQueryParams=function(){var g=this;var h={};h=e.setCPSCommonParams(h);return h};a.prototype.quickTradingQuerySuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){Bestpay.Dialog.showAlertDialog(config.TITLE.dialog_title,g.content,"确定",g.code);return}b.quickTranInfo={perAmount:g.perAmount,allamount:g.allamount,alltransaction:g.alltransaction};b.handleIsneedpassword()};a.prototype.handleIsneedpassword=function(){var g=this;var i=this.quickTranInfo;var h=c.yuan2fen(this.phone_amount_val);console.log("amount : "+h);console.log("quickTranInfo : "+JSON.stringify(i));if(h*1<=1*i.perAmount&&(h*1+1*i.alltransaction)<=1*i.allamount){d("#id_pwd_wrap").hide();b.noPwd=false}else{b.noPwd=true;d("#id_pwd_wrap").show()}console.log("self.userInfo.authenStatus=="+g.userInfo.authenStatus);if(g.userInfo.authenStatus=="A02"){console.log("self.userInfo.hadEpt  "+g.userInfo.hadEpt);if(g.userInfo.hadEpt==1){d("#tianyibao_pay").show();g.getFinancialProducts()}else{d("#tianyibao_pay").hide();g.fundAccountBalanceInquiry()}}else{d("#tianyibao_pay").hide();g.fundAccountBalanceInquiry()}};a.prototype.getFinancialProducts=function(){var g=this;e.callCPSService({service:config.CPS.FINANCIAL_PRODUCTS,params:g.getFinancialProductsParams(),showLoading:false,success:g.getFinancialProductsSuccessCallback})};a.prototype.getFinancialProductsParams=function(){var g=this;var h={};h=e.setCPSCommonParams(h);return h};a.prototype.getFinancialProductsSuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){if(g.code==="018888"){b.fundAccountBalanceInquiry();return}else{Bestpay.Dialog.showAlertDialog("提醒",g.content,"确定",g.code);return}}d("#payfortianyibao").show();var j=g.datas;for(var h=0;h<j.length;h++){b.orderPageJson.productId=j[h]["productId"];b.orderPageJson.userId=j[h]["userId"];b.orderPageJson.tyb_amount=c.fen2yuan(j[h]["balance"])}b.checkBill(b.orderPageJson.tyb_amount,"tyb",1);if(b.checkBillCheck){return}b.fundAccountBalanceInquiry()};a.prototype.fundAccountBalanceInquiry=function(){var g=this;e.callCPSService({service:config.CPS.CCOUNT_BALANCE_QUERY,params:g.fundAccountBalanceInquiryParams(),showLoading:false,success:g.fundAccountBalanceInquirySuccessCallback})};a.prototype.fundAccountBalanceInquiryParams=function(){var g=this;var h={bankMode:g.userInfo.bankMode};h=e.setCPSCommonParams(h);return h};a.prototype.fundAccountBalanceInquirySuccessCallback=function(t){if(t.code!==config.RES.SUCCESS){Bestpay.Dialog.showAlertDialog("提醒",t.content,"确定",t.code);return}console.log("资金账户余额查询 SAcc003出参======="+JSON.stringify(t));var r=t.dayLimit;var h=t.dayTotal;var k=r*1-h*1;var g=t.monthLimit;var n=t.monthTotal;var m=g*1-n*1;var p=t.motherBoard;var o=t.accountItems;for(var l=0;l<o.length;l++){var q=o[l]["acctType"];if(q!=null||q!="null"||q!="undefined"||q!=""){if("0007"==q){var j=o[l].activeBalance;b.orderPageJson.jfy_amount=c.fen2yuan(j);break}}}if(config.CARD_TYPE.BANK_MODE_FUND_POOL_MEMBER_CARD===b.userInfo.bankMode){var s="";if(r==="0"){s=p}else{if(p>k){s=k}else{s=p}}if(g==="0"){s=p}else{if(p>m){s=m}else{s=p}}b.orderPageJson.jfy_amount=c.fen2yuan(s);console.log("子卡＝＝＝＝broadbandSelf.orderPageJson['jfy_amount']=="+b.orderPageJson.jfy_amount)}b.checkBill(b.orderPageJson.jfy_amount,"jfy",0);if(b.checkBillCheck){return}b.getCommission()};a.prototype.gotoChosePay=function(){var g=this;showDialog(config.MSG.loading);g.resetChoseData();goTo(config.page.pay,function(){dismissDialog();d(".main_wrap").each(function(){d(this).on("click",function(){var h=d(this).children(".radio_off");if(h.hasClass("radio_refresh")||h.hasClass("radio_loading")){return}d(".radio_on").removeClass("radio_on");h.addClass("radio_on");g.setChoseData(h.attr("data-value"))})})})};a.prototype.resetChoseData=function(){var g=this;var h=null;g.BroadbandData={};d(".radio_off").removeClass("radio_on");if(b.payType=="0"){h=d(".radio_off").eq(0);if(h.hasClass("radio_refresh")||h.hasClass("radio_loading")){return}d(".radio_off").eq(0).addClass("radio_on")}else{if(b.payType=="1"){h=d(".radio_off").eq(1);if(h.hasClass("radio_refresh")||h.hasClass("radio_loading")){return}d(".radio_off").eq(1).addClass("radio_on")}}};a.prototype.setChoseData=function(h){var g=this;if(h=="0"){g.BroadbandData.payType="0";g.BroadbandData.font="余额付款"}else{if(h=="1"){g.BroadbandData.payType="1";g.BroadbandData.font="添益宝账户余额付款"}}};a.prototype.sureData=function(){var g=this;if(g.BroadbandData.payType=="0"||g.BroadbandData.payType=="1"){b.payType=g.BroadbandData.payType;d(".chosebill span").html(g.BroadbandData.font)}console.log("payType========================="+b.payType);back()};a.prototype.checkBill=function(j,i,h){var g=this};a.prototype.validation=function(){this.phone_area_val=this.phone_area.getToEmptyValue();this.phone_number_val=this.phone_number.getToEmptyValue();this.mobile_val=this.itMobile.getToEmptyValue();this.phone_amount_val=this.phone_amount.getToEmptyValue();var g=this;if(g.validaForm()==false){return}else{if(this.phone_amount_val==null||this.phone_amount_val.length==0){Bestpay.Toast.makeText("请输入充值金额",Bestpay.Toast.LENGTH_SHORT);return}else{if(this.phone_amount_val*1<5||this.phone_amount_val*1>2000){Bestpay.Toast.makeText("请输入5到2000元的整数金额",Bestpay.Toast.LENGTH_SHORT);return}}}if(this.mobile_val.length>=1&&this.mobile_val.length<11){Bestpay.Toast.makeText("请输入11位的顾客手机号码",Bestpay.Toast.LENGTH_SHORT);return}if(g.isReload==true){Bestpay.Toast.makeText("请重新填写固话/宽带号码",Bestpay.Toast.LENGTH_SHORT);return}g.orderPageJson.phone_area_val=this.phone_area_val;g.orderPageJson.phone_number_val=this.phone_number_val;g.orderPageJson.phone_amount_val=(this.phone_amount_val*1).toFixed(2);if(g.BROADBANDNUM=="03010100"){g.orderPageJson.ServiceName="固话号码"}else{if(g.BROADBANDNUM=="03010200"){g.orderPageJson.ServiceName="宽带号码"}}g.itJudgeLocalStorage=new f.JudgeLocalStorage();g.itJudgeLocalStorage.checkOrder(g.phone_area_val+"-"+g.phone_number_val,g.phone_amount_val*1,e.getCurrentTime(),function(){showDialog(config.MSG.loading);b.defferred=d.Deferred();b.defferred.done(g.goPayAnimation);b.getVerifyResp()},g.businessName)};a.prototype.validaForm=function(){var g=this;g.phone_area_val=g.phone_area.getToEmptyValue();g.phone_number_val=g.phone_number.getToEmptyValue();config.isOpen=true;if(g.phone_area_val==null||g.phone_area_val.length==0){Bestpay.Toast.makeText("请输入区号",Bestpay.Toast.LENGTH_SHORT);return false}else{if(g.phone_area_val.length<3||g.phone_area_val.length>5){Bestpay.Toast.makeText("请输入正确的区号",Bestpay.Toast.LENGTH_SHORT);return false}else{if(g.phone_number_val==null||g.phone_number_val.length==0){Bestpay.Toast.makeText("请输入号码",Bestpay.Toast.LENGTH_SHORT);return false}else{if((g.phone_area_val+""+g.phone_number_val).length>64){Bestpay.Toast.makeText("充值号码长度不能大于64位",Bestpay.Toast.LENGTH_SHORT);return false}else{if(g.phone_number_val.length<5){Bestpay.Toast.makeText("请输入正确固话/宽带号",Bestpay.Toast.LENGTH_SHORT);return false}}}}}return true};a.prototype.initConfirm=function(){var h=this;var k=h.orderPageJson.custName_val;var i=h.orderPageJson.amount_val;var j=h.orderPageJson.ifrefush;var g=h.orderPageJson.queryType;if(g=="Y"){if(j=="Y"){d("#payName_parent_img").show()}else{d("#payName_parent_img").hide()}}else{d("#id_confirm_name").hide()}d("#payName_parent_img").on("click",function(){h.getVerifyResp()});h.queryEnd()};a.prototype.getVerifyResp=function(){var g=this;e.callCPSService({service:config.CPS.RECHARE_ACCOUNT_VERIFY,params:g.getVerifyRespParams(),showLoading:false,success:g.getVerifyRespSuccessCallback})};a.prototype.getVerifyRespParams=function(){this.phone_area_val=this.phone_area.getToEmptyValue();this.phone_number_val=this.phone_number.getToEmptyValue();var g=3;if(this.BROADBANDNUM=="03010100"){self.pecProductCode="00000007";g=3}else{if(this.BROADBANDNUM=="03010200"){self.pecProductCode="00000006";g=2}}var h={verify:g,isQryUserInfo:"Y",queryQuantity:"1",accepTareaCode:this.phone_area_val,acctCode:this.phone_area_val+""+this.phone_number_val,reamount:0,acceptDate:c.getDate_YYYYMMDD(),acceptTime:c.getTime_HHMMSS()};h=e.setCPSCommonParams(h);return h};a.prototype.getVerifyRespSuccessCallback=function(h){d("#payamout_parent_img").attr("src","../lib/img/ic_refresh.png");if(h.code!==config.RES.SUCCESS){Bestpay.Dialog.showAlertDialog(config.TITLE.dialog_title,h.content+"("+h.code+")","确定","");return}b.orderPageJson.systemNo=h.systemNo;b.orderPageJson.tradeSeq=h.tradeSeq;b.orderPageJson.flag=h.flag;b.orderPageJson.queryType=h.queryType;b.orderPageJson.reward="0.00";b.orderPageJson.custName_val=h.custName;b.orderPageJson.amount_val=h.amount;b.orderPageJson.ifrefush=h.ifrefush;var i=h.ifrefush;var g=h.queryType;console.log("ifrefush=="+i);console.log("ifrefush=="+g);b.callQuickTradingQuery()};a.prototype.queryEnd=function(){var g=this;var h={businessName:g.businessName,accountName:"固话宽带",accouontValue:g.orderPageJson.phone_area_val+"-"+g.orderPageJson.phone_number_val,rechargeMoney:g.orderPageJson.phone_amount_val,rewardType:g.orderPageJson.rewardType,rewardMoney:g.orderPageJson.reward,jfyBalance:g.orderPageJson.jfy_amount,tybBalance:g.orderPageJson.tyb_amount,enablePassword:g.noPwd,userInfo:g.userInfo,callback:g.gotoOrder};console.log("pluginParam = "+JSON.stringify(h));g.paymentPlugin=new f.paymentPlugin(h);g.payType=g.paymentPlugin.getPayType();console.log("支付方式=="+g.payType);dismissDialog();goTo(config.page.comfirm,function(){});g.defferred.resolve()};a.prototype.goPayAnimation=function(){console.log("done=========================");d("#order_comfirm").removeClass("backPayAnimation").addClass("goPayAnimation")};a.prototype.gotoOrder=function(g){config.TRADE_LIST_QUERY_NUMBER=b.orderPageJson.phone_area_val+""+b.orderPageJson.phone_number_val;e.getRandomServices(function(h){var i=h;if(h.code===config.RES.SUCCESS){b.random=h.randNum}b.rechargeResp(g)},false)};a.prototype.showMagDiv=function(){d("#id_msg_show").show();d("#img_posting").hide();var g=b;g.isReload=false};a.prototype.hideMagDiv=function(){d("#id_msg_show").hide();d("#img_posting").hide();var g=b;g.orderPageJson.custName_val="";g.orderPageJson.amount_val="";g.phone_amount.clearValue();g.isReload=true};a.prototype.getCommission=function(){var g=this;var h=b.orderPageJson.phone_area_val+""+b.orderPageJson.phone_number_val;e.getCommission(config.BUS_TYPE.BUS_TYPE_FIXEDPHONEBROADBAND,g.BROADBANDNUM,g.BROADBANDNUM,g.phone_amount_val,function(i){var j=i;if(i.code===config.RES.SUCCESS){j.commission=c.fen2yuan(i.reward)}else{if(i.code===config.CODE.COMMOSSION_ERROR){j.code=config.RES.SUCCESS;j.commission="0.00"}else{j.code=config.RES.UNKNOWN_ERROR;j.content=config.RES.UNKNOWN_ERROR_MSG}}b.orderPageJson.reward=j.commission;b.orderPageJson.rewardType="reward";b.orderPageJson.supplyCode=j.supplyCode;b.initConfirm()},false,"",g.pecProductCode,h)};a.prototype.gotoRecharge=function(){this.mobile_val=this.itMobile.getToEmptyValue();if(this.mobile_val.length>=1&&this.mobile_val.length<11){Bestpay.Toast.makeText("请输入11位的顾客手机号码",Bestpay.Toast.LENGTH_SHORT);return}else{if(this.mobile_val.length==11&&!this.itMobile.getInputCheck()){Bestpay.Toast.makeText("您输入的手机号号码段不正确",Bestpay.Toast.LENGTH_SHORT);return}}if(this.noPwd){Bestpay.Toast.makeText("请输入您的支付密码",Bestpay.Toast.LENGTH_SHORT)}showDialog(config.MSG.loading);config.TRADE_LIST_QUERY_NUMBER=b.orderPageJson.phone_area_val+""+b.orderPageJson.phone_number_val;config.isBack=function(){back()};e.getRandomServices(function(g){var h=g;if(g.code===config.RES.SUCCESS){b.random=g.randNum}b.rechargeResp()},false)};a.prototype.rechargeResp=function(h){var g=this;e.callCPSService({service:config.CPS.TBRB_CHARGE,params:g.rechargeParams(h),showLoading:true,success:g.rechargeSuccessCallback})};a.prototype.rechargeParams=function(j){var g=this;var h="";if(j!=null&&j!=""){h=j}var i={acceptAreaCode:g.orderPageJson.phone_area_val,acctCode:g.orderPageJson.phone_area_val+""+g.orderPageJson.phone_number_val,busiCode:g.BROADBANDNUM,orderSeq:g.orderPageJson.tradeSeq,payPassWord:Bestpay.Security.encryptPassword(g.userInfo.staffCode,h,g.random),systemNo:g.orderPageJson.systemNo,tradeTime:c.getDate_YYYYMMDD()+""+c.getTime_HHMMSS(),txnAmount:c.yuan2fen(g.orderPageJson.phone_amount_val),supplyCode:g.orderPageJson.supplyCode};if(g.mobile_val!=null&&g.mobile_val.length>0){i.phone=g.mobile_val}else{i.phone=""}if(g.userInfo.hadEpt.toString()=="1"){i.costWay=g.paymentPlugin.getPayType();i.productId=g.productId;i.userId=g.orderPageJson.userId}i=e.setCPSCommonParams(i);return i};a.prototype.rechargeSuccessCallback=function(g){PasswordKeyBoard.hideKeyboardUI3();if(g.code!==config.RES.SUCCESS){if(g.code===config.RES.MONEY_NOT_ENOUGH){Bestpay.Dialog.showAlertDialog(config.TITLE.no_repeat,config.RES.MONEY_NOT_ENOUGH_MSG,"确定",g.code,function(h){back();b.itJudgeLocalStorage.putLocalValue("","","","")});return}if(g.code=="009002"||g.code=="006751"){b.paymentPlugin.setOrderDisplay("overtime");goTo(config.page.float_dia);return}if(g.code==config.RES.PASSWORD_ERROR_LOCKED_002136){Bestpay.Dialog.showAlertDialog(config.TITLE.no_repeat,g.content,"确定",g.code,function(h){App.exitCompleteApp();b.itJudgeLocalStorage.putLocalValue("","","","")});return}Bestpay.Dialog.showAlertDialog(config.TITLE.dialog_title,g.content,"确定",g.code,function(h){back();b.itJudgeLocalStorage.putLocalValue("","","","")});console.log("-----------:"+g.content);return}b.itJudgeLocalStorage.putLocalValue("","","","");b.successJson.transSeq=g.transSeq;b.successJson.txnAmount=c.fen2yuan(g.txnAmount);b.successJson.amount=b.orderPageJson.phone_amount_val;b.successJson.contact=b.orderPageJson.phone_area_val+"-"+b.orderPageJson.phone_number_val;if(b.mobile_val.length>0){e.sendSmsCertificate(g.transSeq,b.mobile_val,"")}b.paymentPlugin.setOrderDisplay("success");goTo(config.page.float_dia);dismissDialog();config.isBack=function(){if(window.jqXHR.readyState>2){Bestpay.App.exitApp()}}};return a});