define(["jquery","bestpay.ui","bestpay.lang","bestpay.http"],function(c,f,b,e){var a=null;function d(){a=this;this.userInfo=JSON.parse(Bestpay.User.getSuccessLoginInfo());this.selectType=null;this.selectAmount=null;this.trafficType="电信话费充值卡";this.mTxnAmount="5000";this.orderPageJson={};this.successJson={};this.infProdCode="1001";this.infActionCode=config.BUS_CODE.ELE_CARD;this.payType="0";this.checkBillCheck=false;this.prepaidRechargeData={};this.productId="0030001";this.defferred=null;this.selectValue="1";this.idAcountItem="50";this.businessName="翼支付卡"}d.prototype.initApp=function(){config.TRADE_LIST_QUERY_TYPE=config.BUS_TYPE.BUS_TYPE_BESTPAY_CARD;var g=this;var h=function(i){console.log(i);console.log(JSON.stringify(i));g.selectValue=i;if(g.selectValue=="1"){c("#textTitleLeft").text("翼支付充值卡");c("#yingzhifuWarm").show();c("#huafeiWarm").hide();config.TRADE_LIST_QUERY_TYPE=config.BUS_TYPE.BUS_TYPE_BESTPAY_CARD;g.businessName="翼支付卡"}else{c("#textTitleLeft").text("电信话费充值卡");c("#yingzhifuWarm").hide();c("#huafeiWarm").show();config.TRADE_LIST_QUERY_TYPE=config.BUS_TYPE.BUS_TYPE_TEL_CARD;g.businessName="话费卡"}c("#AccountSpan").html("50元");g.idAcountHtml="50元";g.idAcountItem="50";console.log("self.selectValue = "+g.selectValue);console.log("textTitleLeft.text = "+c("#textTitleLeft").text())};goTo(config.page.main,function(){g.selectAmount=new f.BlockRadioGroup("brg_amount","item10",h);g.itMobile=new f.InputText("mobile","mobile");g.btnInit()})};d.prototype.btnInit=function(){var g=this;document.getElementById("btn_next").onclick=function(){g.checkBillCheck=false;g.validation()};document.getElementById("btn_Account_down").onclick=function(){goTo(config.page.id_Acount);console.log("self.selectValue = "+g.selectValue);var h={};if(g.selectValue=="1"){h={"10":"10","30":"30","50":"50","100":"100","300":"300"}}else{h={"30":"30","50":"50","100":"100"}}var i=new f.dropDownBox("page_id_Acount",this,h,function(k,j){i.hideDropDownBox();g.idAcountHtml=c(j).html();g.idAcountItem=k;c("#AccountSpan").html(g.idAcountHtml+"元");back()},function(){i.hideDropDownBox();back()})}};d.prototype.validation=function(){var g=this;this.mobile_val=this.itMobile.getToEmptyValue();if(this.mobile_val.length==""){Bestpay.Toast.makeText("请输入顾客手机号码",Bestpay.Toast.LENGTH_SHORT);return}else{if(this.mobile_val.length>=1&&this.mobile_val.length<11){Bestpay.Toast.makeText("请输入11位的顾客手机号码",Bestpay.Toast.LENGTH_SHORT);return}else{if(this.mobile_val.length==11&&!this.itMobile.getInputCheck()){Bestpay.Toast.makeText("您输入的手机号号码段不正确",Bestpay.Toast.LENGTH_SHORT);return}}}g.mTxnAmount=b.yuan2fen(g.idAcountItem);console.log("this.mobile_val = "+this.mobile_val);console.log("self.mTxnAmount = "+g.mTxnAmount);g.itJudgeLocalStorage=new f.JudgeLocalStorage();g.itJudgeLocalStorage.checkOrder(g.mobile_val,g.idAcountItem*1,e.getCurrentTime(),function(){g.queryStart();g.callQuickTradingQuery();g.defferred.done(g.goPayAnimation)},g.businessName)};d.prototype.queryStart=function(){var g=this;g.defferred=c.Deferred();showDialog()};d.prototype.queryEnd=function(){var g=this;g.textTitleLeft=c("#textTitleLeft").text();var h={businessName:g.businessName,accountName:"卡券购买",accouontValue:g.mobile_val,rechargeMoney:b.fen2yuan(g.mTxnAmount),rewardMoney:g.orderPageJson.reward,jfyBalance:g.orderPageJson.jfy_amount,tybBalance:g.orderPageJson.tyb_amount,enablePassword:g.noPwd,userInfo:g.userInfo,callback:g.gotoOrder};console.log("pluginParam = "+JSON.stringify(h));g.paymentPlugin=new f.paymentPlugin(h);dismissDialog();goTo(config.page.comfirm,function(){});g.defferred.resolve()};d.prototype.goPayAnimation=function(){console.log("done=========================");c("#order_comfirm").removeClass("backPayAnimation").addClass("goPayAnimation")};d.prototype.gotoOrder=function(g){e.getRandomServices(function(h){var i=h;if(h.code===config.RES.SUCCESS){a.random=h.randNum}if(a.selectValue=="1"){a.rechargeResp(g)}else{a.rechargeRespTCard(g)}},false)};d.prototype.callQuickTradingQuery=function(){var g=this;e.callCPSService({service:config.CPS.QUICK_TRADING_QUERY,params:g.quickTradingQueryParams(),showLoading:false,success:g.quickTradingQuerySuccessCallback})};d.prototype.quickTradingQueryParams=function(){var g=this;var h={};h=e.setCPSCommonParams(h);return h};d.prototype.quickTradingQuerySuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){Bestpay.Dialog.showAlertDialog(config.TITLE.dialog_title,g.content,"确定",g.code);return}a.getPremium();a.quickTranInfo={perAmount:g.perAmount,allamount:g.allamount,alltransaction:g.alltransaction}};d.prototype.getPremium=function(){var g=this;e.getPremium(g.mTxnAmount,g.infActionCode,g.infProdCode,function(h){if(h.code!==config.RES.SUCCESS){Bestpay.Dialog.showAlertDialog(config.TITLE.dialog_title,h.content,"确定",h.code);return}a.orderPageJson.retFaceAmount=h.amount;a.orderPageJson.retPremium=h.concession;a.orderPageJson.account_amount_val=b.fen2yuan(h.amount*1+h.concession*1);a.handleIsneedpassword()},false)};d.prototype.getCommission=function(){var g=this;e.getCommission(config.BUS_TYPE.BUS_TYPE_TEL_CARD_TELECOM,config.BUS_CODE.ELE_CARD,config.BUS_CODE.ELE_CARD,(g.mTxnAmount*1)/100,function(h){var i=h;if(i.code!==config.RES.SUCCESS){console.log(i.content+"("+i.code+")")}if(h.code===config.RES.SUCCESS){i.commission=b.fen2yuan(h.reward)}else{if(h.code===config.CODE.COMMOSSION_ERROR){i.code=config.RES.SUCCESS;i.commission="0.00"}else{i.code=config.RES.UNKNOWN_ERROR;i.content=config.RES.UNKNOWN_ERROR_MSG}}a.orderPageJson.reward=i.commission;a.queryEnd()},false)};d.prototype.rechargeResp=function(h){var g=this;e.callCPSService({service:config.CPS.ELECTRONIC_SELL_CARD,params:g.rechargeParams(h),showLoading:true,success:g.rechargeSuccessCallback})};d.prototype.rechargeParams=function(j){var g=this;var h="";if(j!=null&&j!=""){h=j}var i={orderNo:e.getOrderSeq(),cardAmount:g.mTxnAmount,cardTypeCode:"2004",payType:"0",payPassword:Bestpay.Security.encryptPassword(g.userInfo.staffCode,h,g.random),tradeTime:b.getDate_YYYYMMDD()+""+b.getTime_HHMMSS(),phone:g.mobile_val};if(g.userInfo.hadEpt.toString()=="1"){i.costWay=g.paymentPlugin.getPayType();i.productId=g.productId;i.userId=g.orderPageJson.userId}i=e.setCPSCommonParams(i);return i};d.prototype.rechargeSuccessCallback=function(g){dismissDialog();PasswordKeyBoard.hideKeyboardUI3();if(g.code!==config.RES.SUCCESS){if(g.code===config.RES.MONEY_NOT_ENOUGH){Bestpay.Dialog.showAlertDialog(config.TITLE.no_repeat,config.RES.MONEY_NOT_ENOUGH_MSG,"确定",g.code,function(){a.itJudgeLocalStorage.putLocalValue("","","","")});return}if(g.code=="009002"||g.code=="006751"){console.log("in-------------------");a.paymentPlugin.setOrderDisplay("overtime");goTo(config.page.float_dia);return}if(g.code==config.RES.PASSWORD_ERROR_LOCKED_002136){Bestpay.Dialog.showAlertDialog(config.TITLE.no_repeat,g.content,"确定",g.code,function(h){App.exitCompleteApp();a.itJudgeLocalStorage.putLocalValue("","","","")})}Bestpay.Dialog.showAlertDialog(config.TITLE.dialog_title,g.content,"确定",g.code,function(){a.itJudgeLocalStorage.putLocalValue("","","","")});return}a.itJudgeLocalStorage.putLocalValue("","","","");e.sendSmsCertificate(g.transSeq,a.mobile_val,"");a.paymentPlugin.setOrderDisplay("success");goTo(config.page.float_dia);config.isBack=function(){if(window.jqXHR.readyState>2){Bestpay.App.exitApp()}}};d.prototype.rechargeRespTCard=function(h){var g=this;e.callCPSService({service:config.CPS.ELECTRONIC_SELL_CARD,params:g.rechargeRespTCardParams(h),showLoading:true,success:g.rechargeRespTCardSuccessCallback,error:g.rechargeRespTCardErrorCallback})};d.prototype.rechargeRespTCardParams=function(j){var g=this;var h="";if(j!=null&&j!=""){h=j}var i={orderNo:e.getOrderSeq(),payPassword:Bestpay.Security.encryptPassword(g.userInfo.staffCode,h,g.random),payType:"0",cardAmount:g.mTxnAmount,cardTypeCode:g.infProdCode,tradeTime:b.getDate_YYYYMMDD()+""+b.getTime_HHMMSS(),phone:g.mobile_val};if(g.userInfo.hadEpt.toString()=="1"){i.costWay=g.paymentPlugin.getPayType();i.productId=g.productId;i.userId=g.orderPageJson.userId}i=e.setCPSCommonParams(i);console.log("电子售卡接口 TCard001入参======="+JSON.stringify(i));return i};d.prototype.rechargeRespTCardSuccessCallback=function(g){dismissDialog();PasswordKeyBoard.hideKeyboardUI3();if(g.code!==config.RES.SUCCESS){if(g.code==config.RES.CARD_NOT_ENOUGH){Bestpay.Dialog.showAlertDialog("提醒",config.RES.CARD_NOT_ENOUGH_MSG,"确定",g.code,function(){a.itJudgeLocalStorage.putLocalValue("","","","")});return}if(g.code=="009002"||g.code=="006751"){console.log("in-------------------");a.paymentPlugin.setOrderDisplay("overtime");goTo(config.page.float_dia);return}if(g.code===config.RES.MONEY_NOT_ENOUGH){Bestpay.Dialog.showAlertDialog(config.TITLE.no_repeat,config.RES.MONEY_NOT_ENOUGH_MSG,"确定",g.code,function(){a.itJudgeLocalStorage.putLocalValue("","","","")});return}if(g.code==config.RES.PASSWORD_ERROR_LOCKED_002136){Bestpay.Dialog.showAlertDialog("提醒",g.content,"确定",g.code,function(){App.exitCompleteApp();a.itJudgeLocalStorage.putLocalValue("","","","")})}else{Bestpay.Dialog.showAlertDialog("提醒",g.content,"确定",g.code,function(){a.itJudgeLocalStorage.putLocalValue("","","","")})}return}a.itJudgeLocalStorage.putLocalValue("","","","");console.log("电子售卡接口 TCard001出参========"+JSON.stringify(g));e.sendSmsCertificate(g.transSeq,a.mobile_val,"");a.paymentPlugin.setOrderDisplay("success");goTo(config.page.float_dia);config.isBack=function(){if(window.jqXHR.readyState>2){Bestpay.App.exitApp()}}};d.prototype.rechargeRespTCardErrorCallback=function(g){if(g.code===config.RES.MONEY_NOT_ENOUGH){Bestpay.Dialog.showAlertDialog("提醒","余额不足","确定",config.RES.MONEY_NOT_ENOUGH,function(){a.itJudgeLocalStorage.putLocalValue("","","","")});return}};d.prototype.handleIsneedpassword=function(){var g=this;var j=this.quickTranInfo;var i=this.orderPageJson.retFaceAmount*1+this.orderPageJson.retPremium*1;var h=this.mTxnAmount;if(h*1==i*1){c("#id_premium_item").hide()}else{c("#id_premium_item").show()}console.log("amount : "+i);console.log("quickTranInfo : "+JSON.stringify(j));if(i*1<=1*j.perAmount&&(i*1+1*j.alltransaction)<=1*j.allamount){a.noPwd=false}else{a.noPwd=true}console.log("self.userInfo.authenStatus=="+g.userInfo.authenStatus);if(g.userInfo.authenStatus=="A02"){showDialog(config.MSG.loading);console.log("self.userInfo.hadEpt  "+g.userInfo.hadEpt);if(g.userInfo.hadEpt==1){g.getFinancialProducts()}else{g.fundAccountBalanceInquiry()}}else{g.fundAccountBalanceInquiry()}};d.prototype.getFinancialProducts=function(){var g=this;e.callCPSService({service:config.CPS.FINANCIAL_PRODUCTS,params:g.getFinancialProductsParams(),showLoading:false,success:g.getFinancialProductsSuccessCallback})};d.prototype.getFinancialProductsParams=function(){var g=this;var h={};h=e.setCPSCommonParams(h);return h};d.prototype.getFinancialProductsSuccessCallback=function(g){if(g.code!==config.RES.SUCCESS){if(g.code==="018888"){a.fundAccountBalanceInquiry();return}else{Bestpay.Dialog.showAlertDialog("提醒",g.content,"确定",g.code);return}}c("#payfortianyibao").show();var j=g.datas;for(var h=0;h<j.length;h++){a.orderPageJson.productId=j[h]["productId"];a.orderPageJson.userId=j[h]["userId"];a.orderPageJson.tyb_amount=b.fen2yuan(j[h]["balance"])}a.fundAccountBalanceInquiry()};d.prototype.fundAccountBalanceInquiry=function(){var g=this;e.callCPSService({service:config.CPS.CCOUNT_BALANCE_QUERY,params:g.fundAccountBalanceInquiryParams(),showLoading:false,success:g.fundAccountBalanceInquirySuccessCallback})};d.prototype.fundAccountBalanceInquiryParams=function(){var g=this;var h={bankMode:g.userInfo.bankMode};h=e.setCPSCommonParams(h);return h};d.prototype.fundAccountBalanceInquirySuccessCallback=function(t){if(t.code!==config.RES.SUCCESS){Bestpay.Dialog.showAlertDialog("提醒",t.content,"确定",t.code);return}console.log("资金账户余额查询 SAcc003出参======="+JSON.stringify(t));var r=t.dayLimit;var h=t.dayTotal;var k=r*1-h*1;var g=t.monthLimit;var n=t.monthTotal;var m=g*1-n*1;var p=t.motherBoard;var o=t.accountItems;for(var l=0;l<o.length;l++){var q=o[l]["acctType"];if(q!=null||q!="null"||q!="undefined"||q!=""){if("0007"==q){var j=o[l].activeBalance;a.orderPageJson.jfy_amount=b.fen2yuan(j);break}}}if(config.CARD_TYPE.BANK_MODE_FUND_POOL_MEMBER_CARD===a.userInfo.bankMode){var s="";if(r==="0"){s=p}else{if(p>k){s=k}else{s=p}}if(g==="0"){s=p}else{if(p>m){s=m}else{s=p}}a.orderPageJson.jfy_amount=b.fen2yuan(s);console.log("子卡＝＝＝＝prepaidRechargeSelf.orderPageJson['jfy_amount']=="+a.orderPageJson.jfy_amount)}a.getCommission()};return d});